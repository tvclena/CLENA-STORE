<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-T97MS35TJ6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-T97MS35TJ6');
</script>
<title>ConfiguraÃ§Ãµes</title>

<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#ff6a00">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* =========================================================
   SISTEMA DE CONFIGURAÃ‡Ã•ES â€¢ VISUAL PREMIUM
   PadrÃ£o SaaS / F360 / Stripe
========================================================= */

:root{
  --primary:#ff6a00;
  --bg:#f6f7fb;
  --card:#ffffff;
  --border:#e5e7eb;
  --text:#111827;
  --muted:#6b7280;
  --success:#16a34a;
  --blue:#2563eb;
  --radius:14px;
  --shadow:0 10px 30px rgba(0,0,0,.06);
}

*{
  box-sizing:border-box;
  font-family:'Inter',system-ui,-apple-system,sans-serif;
}

/* ================= BASE ================= */
body{
  margin:0;
  background:var(--bg);
  padding:28px 18px 40px;
  color:var(--text);
  opacity:0;
  animation:fade .4s ease forwards;
}

@keyframes fade{to{opacity:1}}

/* ================= CARDS ================= */
.card{
  max-width:760px;
  margin:0 auto 22px;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:26px;
  box-shadow:var(--shadow);
}

/* ================= TIPOGRAFIA ================= */
h1{
  font-size:20px;
  font-weight:800;
  margin:0 0 6px;
}

h2{
  font-size:14px;
  font-weight:800;
  letter-spacing:.04em;
  text-transform:uppercase;
  margin-bottom:6px;
  color:#374151;
}

p{
  font-size:13px;
  line-height:1.45;
  color:var(--muted);
  margin-bottom:16px;
}

/* ================= LINK LOJA ================= */
.link-row{
  display:grid;
  grid-template-columns:1fr auto;
  gap:10px;
  margin-bottom:12px;
}

.link-box{
  background:#f9fafb;
  border:1px dashed var(--border);
  border-radius:12px;
  padding:14px;
  font-size:13px;
  word-break:break-all;
}

/* ================= BOTÃ•ES ================= */
button{
  height:44px;
  border:none;
  border-radius:12px;
  background:var(--primary);
  color:#fff;
  font-size:14px;
  font-weight:700;
  cursor:pointer;
  transition:.2s;
}

button:hover{filter:brightness(.95)}
button:active{transform:scale(.98)}

.whats{
  background:#ecfdf5;
  color:#166534;
  border:1px solid #bbf7d0;
}

.btn-close{
  background:#f3f4f6;
  color:#111827;
  border:1px solid var(--border);
}

.btn-palette{
  width:48px;
  height:48px;
  border-radius:12px;
  background:#111827;
  color:#fff;
  font-size:20px;
  display:flex;
  align-items:center;
  justify-content:center;
}

/* ================= MERCADO PAGO ================= */
.mp-header{
  display:flex;
  align-items:center;
  gap:14px;
  margin-bottom:10px;
}

.mp-header img{
  width:120px;
}

.steps{
  background:#f9fafb;
  border:1px solid var(--border);
  border-radius:12px;
  padding:14px 16px;
  margin-bottom:16px;
}

.steps li{
  font-size:13px;
  margin-bottom:8px;
}

.steps a{
  color:var(--blue);
  font-weight:700;
  text-decoration:underline;
  cursor:pointer;
}

/* ================= INPUT ================= */
input{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#fff;
  font-size:14px;
  margin-bottom:12px;
}

input:focus{
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 2px rgba(255,106,0,.15);
}

/* ================= STATUS ================= */
.status{
  background:#ecfdf5;
  border:1px solid #bbf7d0;
  color:#166534;
  border-radius:12px;
  padding:14px;
  font-size:14px;
  font-weight:700;
  text-align:center;
}

/* ================= MODAL VIDEO ================= */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

.modal.show{display:flex}

.modal-box{
  width:92%;
  max-width:420px;
  background:#fff;
  border-radius:20px;
  padding:20px;
  box-shadow:0 30px 80px rgba(0,0,0,.35);
}

.modal-box video{
  width:100%;
  border-radius:14px;
  margin-bottom:12px;
}

.modal-actions{
  display:grid;
  gap:10px;
}

/* ================= CONFIG LOJA ================= */
#configLojaOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.65);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:10000;
}

#configLojaOverlay > div{
  width:94%;
  max-width:420px;
  background:#fff;
  border-radius:20px;
  padding:22px;
  box-shadow:0 30px 80px rgba(0,0,0,.35);
}

#configLojaOverlay h2{
  font-size:16px;
  font-weight:800;
}

#configLojaOverlay p{
  font-size:13px;
}

/* PALETAS */
.paleta{
  height:40px;
  border-radius:10px;
  cursor:pointer;
  border:2px solid transparent;
  box-shadow:0 4px 12px rgba(0,0,0,.18);
}

.paleta:hover{
  border-color:#111827;
}

/* PREVIEW */
#previewCard{
  margin:16px 0;
  border-radius:14px;
  padding:16px;
  font-size:14px;
  text-align:center;
  font-weight:800;
}

</style>
</head>

<body>

<!-- ================= LINK DA LOJA ================= -->
<div class="card">
  <h2 id="nomeLoja">Sua loja</h2>
  <p>Compartilhe com seus clientes</p>

<div class="link-row">
  <div class="link-box" id="linkLoja">Carregandoâ€¦</div>

  <button class="btn-palette" onclick="abrirConfigLoja()" title="Personalizar aparÃªncia">
    ğŸ¨
  </button>
</div>

  <button onclick="copiarLink()">ğŸ“‹ Copiar link</button>
  <button class="whats" style="margin-top:10px" onclick="compartilharWhats()">ğŸ“² Compartilhar no WhatsApp</button>
</div>

<!-- ================= MERCADO PAGO ================= -->
<div class="card">

  <div class="mp-header">
    <img src="logomp.png">
    <h1>Pagamentos Online</h1>
  </div>

  <p id="mensagemLoja"></p>

  <ol class="steps">
    <li>Acessar vÃ­deo explicativo <a onclick="abrirVideo()">clique aqui</a></li>
    <li>Copie o <b>Access Token de PRODUÃ‡ÃƒO</b></li>
    <li>âŒ NÃ£o utilize token de teste</li>
    <li>âš ï¸ DICAS IMPORTANTES <b>acesso por celular</b></li>
    <li>Ative â€œVersÃ£o para computadorâ€ no navegador se nÃ£o aparecer</li>
    <li>Chrome: â‹® â†’ VersÃ£o para computador</li>
    <li>Safari (iPhone): aA â†’ Solicitar site para computador</li>
    <li>Copie com cuidado (nÃ£o pegar espaÃ§os)</li>
  </ol>

  <div id="formToken">
    <input id="token" placeholder="Cole aqui o MP_ACCESS_TOKEN">
    <button onclick="salvarToken()">Ativar pagamentos online</button>
  </div>

  <div id="statusAtivo" class="status" style="display:none">
    âœ… Pagamentos online ativados com sucesso
  </div>

  <button class="whats" style="margin-top:14px" onclick="suporte()">ğŸ’¬ Falar com suporte</button>

</div>

<!-- ================= MODAL VÃDEO ================= -->
<div class="modal" id="modalVideo">
  <div class="modal-box">
    <video controls src="" id="videoPlayer"></video>

    <p style="font-size:13px;color:#6b7280;margin-bottom:12px">
      Neste vÃ­deo vocÃª verÃ¡ exatamente onde encontrar o Access Token de produÃ§Ã£o no Mercado Pago.
    </p>

    <div class="modal-actions">
      <button onclick="prosseguir()">Prosseguir</button>
      <button class="btn-close" onclick="fecharVideo()">Fechar</button>
    </div>
  </div>
</div>

<script>
const VIDEO_URL = "https://egxjgmzukjyyxmkukwub.supabase.co/storage/v1/object/public/videosfront/Gravando%202026-01-06%20195208%20(1).mp4";
const LINK_PROSSEGUIR = "https://www.mercadopago.com.br/developers/panel/credentials";

const sb = supabase.createClient(
  "https://egxjgmzukjyyxmkukwub.supabase.co",
  "sb_publishable_EWwdrLOUk6KDHZGLuh4uRg_QDRtLeFi"
);

let lojaId, linkPublico, nomeLoja;
let corPrimaryAtual = "#ff6a00";
let corTextoAtual = "#ffffff";

/* APLICA TEMA NA PÃGINA */
function aplicarTema(){
  document.documentElement.style.setProperty("--primary", corPrimaryAtual);
  document.documentElement.style.setProperty("--text", corTextoAtual);

  const preview = document.getElementById("previewCard");
  if(preview){
    preview.style.background = corPrimaryAtual;
    preview.style.color = corTextoAtual;
  }
}

/* PALETAS */
function usarPaleta(bg, txt){
  corPrimaryAtual = bg;
  corTextoAtual = txt;
  document.getElementById("corPrimary").value = bg;
  document.getElementById("corTexto").value = txt;
  aplicarTema();
}

/* ABRIR POPUP */
async function abrirConfigLoja(){
  document.getElementById("configLojaOverlay").style.display = "flex";

  const { data, error } = await sb
    .from("loja_config")
    .select("*")
    .eq("user_id", lojaId)
    .maybeSingle();

  if(error){
    console.error(error);
    return;
  }

  if(data){
    corPrimaryAtual = data.primary_color;
    corTextoAtual   = data.text_color;
  }

  corPrimary.value = corPrimaryAtual;
  corTexto.value   = corTextoAtual;

  aplicarTema();
}


/* FECHAR */
function fecharConfigLoja(){
  document.getElementById("configLojaOverlay").style.display="none";
}

/* SALVAR */
async function salvarConfigLoja(){
  const { error } = await sb
    .from("loja_config")
    .upsert(
      {
        user_id: lojaId,
        primary_color: corPrimaryAtual,
        secondary_color: corPrimaryAtual,
        text_color: corTextoAtual,
        updated_at: new Date()
      },
      {
        onConflict: "user_id"
      }
    );

  if(error){
    console.error(error);
    alert("Erro ao salvar aparÃªncia");
    return;
  }

  aplicarTema();
  alert("AparÃªncia atualizada com sucesso ğŸ‰");
  fecharConfigLoja();
}

function aplicarTema(){
  document.documentElement.style.setProperty("--primary", corPrimaryAtual);
  document.documentElement.style.setProperty("--primary-2", corPrimaryAtual);
  document.documentElement.style.setProperty("--text", corTextoAtual);

  const preview = document.getElementById("previewCard");
  if(preview){
    preview.style.background = corPrimaryAtual;
    preview.style.color = corTextoAtual;
  }
}


(async ()=>{
  const {data:{session}} = await sb.auth.getSession();
  if(!session) return location.href="login.html";

  lojaId = session.user.id;
  linkPublico = `${location.origin}/loja.html?l=${lojaId}`;
  linkLoja.innerText = linkPublico;

  const {data} = await sb
    .from("user_profile")
    .select("negocio,pagamento_online_ativo")
    .eq("user_id", lojaId)
    .single();

  nomeLoja = data?.negocio || "sua loja";
  nomeLojaEl = document.getElementById("nomeLoja");
  nomeLojaEl.innerText = nomeLoja;

  mensagemLoja.innerText =
    `Ative os pagamentos online para que os clientes da ${nomeLoja} possam pagar direto pela agenda.`;

  if(data?.pagamento_online_ativo){
    formToken.style.display="none";
    statusAtivo.style.display="block";
  }
})();

function copiarLink(){
  navigator.clipboard.writeText(linkPublico);
  alert("Link copiado com sucesso âœ…");
}

function compartilharWhats(){
  const msg = `OlÃ¡ ğŸ˜Š\n\nAcesse a ${nomeLoja} e pague online:\n${linkPublico}`;
  window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`,"_blank");
}

function abrirVideo(){
  videoPlayer.src = VIDEO_URL;
  modalVideo.classList.add("show");
}
function fecharVideo(){
  videoPlayer.pause();
  modalVideo.classList.remove("show");
}
function prosseguir(){
  window.open(LINK_PROSSEGUIR,"_blank");
}

function tokenValido(t){
  return t.startsWith("APP_USR-") && t.length > 60;
}

async function salvarToken(){
  const t = token.value.trim();
  if(!tokenValido(t)) return alert("Token invÃ¡lido");

  const res = await fetch("/api/salvar-credencial-mp",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ loja_id: lojaId, mp_access_token: t })
  });

  if(!res.ok) return alert("Erro ao ativar integraÃ§Ã£o");

  formToken.style.display="none";
  statusAtivo.style.display="block";
}

function suporte(){
  window.open("https://wa.me/5575998112535","_blank");
}
function abrirConfigLoja(){
  document.getElementById("configLojaOverlay").style.display = "flex";
}

document.addEventListener("DOMContentLoaded", ()=>{
  document.getElementById("corPrimary").addEventListener("input", e=>{
    corPrimaryAtual = e.target.value;
    aplicarTema();
  });

  document.getElementById("corTexto").addEventListener("input", e=>{
    corTextoAtual = e.target.value;
    aplicarTema();
  });
});

</script>
<!-- ================= POPUP CONFIGURAÃ‡ÃƒO DA LOJA ================= -->
<div id="configLojaOverlay" style="
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.65);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:10000;
">
  <div style="
    background:#fff;
    width:94%;
    max-width:420px;
    border-radius:28px;
    padding:20px;
    box-shadow:0 30px 90px rgba(0,0,0,.35);
    animation:cardIn .35s ease forwards;
  ">

    <h2 style="margin-bottom:6px">ğŸ¨ AparÃªncia da loja</h2>
    <p style="font-size:13px;color:#6b7280;margin-bottom:14px">
      Escolha uma paleta ou personalize manualmente
    </p>

    <!-- PALETAS PRÃ‰-DEFINIDAS -->
    <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:14px">
      <div class="paleta" style="background:#ff6a00" onclick="usarPaleta('#ff6a00','#ffffff')"></div>
      <div class="paleta" style="background:#2563eb" onclick="usarPaleta('#2563eb','#ffffff')"></div>
      <div class="paleta" style="background:#16a34a" onclick="usarPaleta('#16a34a','#ffffff')"></div>
      <div class="paleta" style="background:#7c3aed" onclick="usarPaleta('#7c3aed','#ffffff')"></div>
      <div class="paleta" style="background:#0f172a" onclick="usarPaleta('#0f172a','#ffffff')"></div>
    </div>

    <!-- CORES MANUAIS -->
    <label style="font-size:12px;font-weight:800">Cor principal</label>
    <input type="color" id="corPrimary" style="width:100%;height:42px;border-radius:10px;border:none;margin-bottom:10px">

    <label style="font-size:12px;font-weight:800">Cor do texto</label>
    <input type="color" id="corTexto" style="width:100%;height:42px;border-radius:10px;border:none">

    <!-- PREVIEW -->
    <div id="previewCard" style="
      margin:16px 0;
      border-radius:18px;
      padding:14px;
      color:#fff;
      font-weight:800;
    ">
      Exemplo de banner da loja
    </div>

    <button onclick="salvarConfigLoja()">ğŸ’¾ Salvar aparÃªncia</button>
    <button class="btn-close" style="margin-top:10px" onclick="fecharConfigLoja()">Fechar</button>
  </div>
</div>

<style>
.paleta{
  height:44px;
  border-radius:12px;
  cursor:pointer;
  box-shadow:0 6px 18px rgba(0,0,0,.18);
}
</style>

</body>
</html>
