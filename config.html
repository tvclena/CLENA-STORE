<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Pagamentos Online ‚Ä¢ Agenda F√°cil</title>

<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#ff6a00">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primary:#ff6a00;
  --bg:#f4f6fb;
  --card:#ffffff;
  --border:#e5e7eb;
  --text:#111827;
  --muted:#6b7280;
  --success:#16a34a;
  --danger:#dc2626;
}

*{box-sizing:border-box;font-family:Inter}

body{
  background:var(--bg);
  padding:20px;
}

/* CARD BASE */
.card{
  background:var(--card);
  border-radius:22px;
  padding:22px;
  box-shadow:0 12px 30px rgba(0,0,0,.08);
  margin-bottom:18px;
}

h1{
  font-size:20px;
  font-weight:800;
  margin-bottom:6px;
}

h2{
  font-size:16px;
  margin-bottom:10px;
}

p{
  font-size:14px;
  color:var(--muted);
  margin-bottom:14px;
}

/* LINK DA LOJA */
.link-box{
  border:1px dashed var(--border);
  border-radius:14px;
  padding:10px;
  font-size:12px;
  background:#fafafa;
  word-break:break-all;
}

/* MERCADO PAGO */
.mp-header{
  display:flex;
  align-items:center;
  gap:12px;
}

.mp-header img{
  width:42px;
}

/* PASSOS */
.steps li{
  font-size:14px;
  margin-bottom:8px;
}

.steps b{
  color:#111;
}

/* INPUT */
input{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:1px solid var(--border);
  font-size:14px;
  margin-bottom:10px;
}

/* BUTTONS */
button{
  width:100%;
  height:46px;
  border:none;
  border-radius:999px;
  background:linear-gradient(135deg,#ff6a00,#ff9a57);
  color:#fff;
  font-weight:800;
  font-size:14px;
  cursor:pointer;
}

.whats{
  background:#dcfce7;
  color:#15803d;
  margin-top:10px;
}

/* STATUS */
.status{
  padding:14px;
  border-radius:14px;
  font-size:14px;
  font-weight:700;
}

.status.active{
  background:#ecfdf5;
  color:var(--success);
}

/* ALERT */
.alert{
  background:#fff7ed;
  color:#92400e;
  padding:12px;
  border-radius:14px;
  font-size:13px;
}
</style>
</head>

<body>

<!-- LINK LOJA -->
<div class="card">
  <h2>Link da sua loja</h2>
  <p>Compartilhe com seus clientes</p>
  <div class="link-box" id="linkLoja">Carregando‚Ä¶</div>
</div>

<!-- MERCADO PAGO -->
<div class="card">

  <div class="mp-header">
    <img src="https://www.mercadopago.com/org-img/MP3/API/logos/mp-logo.png">
    <h1>Pagamentos Online</h1>
  </div>

  <p>Ative pagamentos online com Mercado Pago</p>

  <ol class="steps">
    <li>1Ô∏è‚É£ Acesse <b>mercadopago.com.br</b></li>
    <li>2Ô∏è‚É£ Entre em <b>Configura√ß√µes ‚Üí Credenciais</b></li>
    <li>3Ô∏è‚É£ Copie o <b>Access Token de PRODU√á√ÉO</b></li>
    <li>‚ùå N√£o use token de teste (TEST-)</li>
  </ol>

  <div id="formToken">
    <input id="token" placeholder="Cole aqui o MP_ACCESS_TOKEN de produ√ß√£o">
    <button onclick="salvarToken()">Ativar integra√ß√£o</button>
  </div>

  <div id="statusAtivo" class="status active" style="display:none">
    ‚úÖ Integra√ß√£o com Mercado Pago ativa<br>
    Produtos e servi√ßos marcados como pagamento online j√° est√£o dispon√≠veis.
  </div>

  <div class="alert" style="margin-top:14px">
    ‚ö†Ô∏è Uma vez cadastrada, a chave n√£o pode ser alterada pelo painel.<br>
    Para altera√ß√µes, entre em contato com o suporte.
  </div>

  <button class="whats" onclick="suporte()">
    üí¨ Falar com suporte no WhatsApp
  </button>

</div>

<script>
const sb = supabase.createClient(
  "https://egxjgmzukjyyxmkukwub.supabase.co",
  "sb_publishable_EWwdrLOUk6KDHZGLuh4uRg_QDRtLeFi"
);

let lojaId;

/* LINK */
async function carregar(){
  const {data:{session}} = await sb.auth.getSession();
  if(!session) return location.href="login.html";

  lojaId = session.user.id;

  document.getElementById("linkLoja").innerText =
    `${location.origin}/AgendaBeauty/loja.html?l=${lojaId}`;

  const {data} = await sb
    .from("user_profile")
    .select("pagamento_online_ativo")
    .eq("user_id", lojaId)
    .single();

  if(data?.pagamento_online_ativo){
    document.getElementById("formToken").style.display="none";
    document.getElementById("statusAtivo").style.display="block";
  }
}
carregar();

/* VALIDAR TOKEN */
function tokenValido(t){
  return t.startsWith("APP_USR-") && t.length > 60;
}

/* SALVAR TOKEN (VAI PARA BACKEND COM SERVICE ROLE) */
async function salvarToken(){
  const token = document.getElementById("token").value.trim();

  if(!tokenValido(token)){
    alert("Token inv√°lido. Use o Access Token de PRODU√á√ÉO.");
    return;
  }

  alert("Integra√ß√£o ativada com sucesso ‚úÖ");
  document.getElementById("formToken").style.display="none";
  document.getElementById("statusAtivo").style.display="block";

  // üîí envio real ser√° feito via Vercel com service_role
}

/* SUPORTE */
function suporte(){
  window.open(
    "https://wa.me/5575998112535?text=Tenho d√∫vidas sobre integra√ß√£o Mercado Pago",
    "_blank"
  );
}
</script>

</body>
</html>
