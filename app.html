<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-T97MS35TJ6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-T97MS35TJ6');
</script>
<title>App cliente</title>
  
<meta name="viewport"
  content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">

<meta name="theme-color" content="#ff6a00">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primary:#ff6a00;
  --bg:#f4f6fb;
  --border:#e5e7eb;
  --text:#111827;
  --muted:#6b7280;
  --danger:#dc2626;
  --topbar-h:56px;
  --navbar-h:68px;
}

*{margin:0;padding:0;box-sizing:border-box;font-family:Inter}
html,body{width:100%;height:100%;background:var(--bg);overflow:hidden}

/* TOPBAR */
.topbar{
  position:fixed;top:0;left:0;right:0;
  height:var(--topbar-h);
  background:#fff;
  border-bottom:1px solid var(--border);
  padding:0 16px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  z-index:10;
}
.topbar h1{font-size:18px;font-weight:800}

/* AVATAR */
.avatar{
  width:36px;height:36px;border-radius:50%;
  background:linear-gradient(135deg,#ff6a00,#ff9a57);
  display:flex;align-items:center;justify-content:center;
  color:#fff;font-weight:800;
  cursor:pointer;
  background-size:cover;
  background-position:center;
}

/* CONTENT */
.content{
  position:fixed;
  top:var(--topbar-h);
  bottom:var(--navbar-h);
  left:0;right:0;
  background:#fff;
}
iframe{width:100%;height:100%;border:none}

/* NAVBAR */
.navbar{
  position:fixed;
  bottom:0;left:0;right:0;
  height:var(--navbar-h);
  background:#fff;
  border-top:1px solid var(--border);
  display:flex;
  justify-content:space-around;
  align-items:center;
}
.nav-item{
  font-size:11px;
  color:var(--muted);
  display:flex;
  flex-direction:column;
  align-items:center;
  cursor:pointer;
}
.nav-item i{font-size:22px}
.nav-item.active{color:var(--primary)}

/* PROFILE OVERLAY */
#profileOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

/* PROFILE MODAL */
.profile-modal{
  width:92%;
  max-width:420px;
  background:#fff;
  border-radius:26px;
  padding:20px;
  max-height:90vh;
  overflow:auto;
  scrollbar-width:none;
}
.profile-modal::-webkit-scrollbar{display:none}

/* PROFILE IMG */
.profile-img{
  width:90px;height:90px;border-radius:50%;
  background:#eee;
  background-size:cover;
  background-position:center;
  margin:0 auto 12px;
  position:relative;
}
.profile-img .cam{
  position:absolute;
  right:-4px;bottom:-4px;
  width:34px;height:34px;
  border-radius:50%;
  background:linear-gradient(135deg,#ff6a00,#ff9a57);
  display:flex;align-items:center;justify-content:center;
  color:#fff;
  border:3px solid #fff;
  cursor:pointer;
}

/* FIELDS */
.field{margin-bottom:10px}
.field input{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid var(--border);
}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}

/* BUTTONS */
.btn{
  width:100%;
  padding:14px;
  border:none;
  border-radius:999px;
  font-weight:800;
  cursor:pointer;
}
.btn-primary{background:var(--primary);color:#fff}
.btn-danger{background:#fee2e2;color:var(--danger)}
.btn-ghost{background:#f3f4f6;color:#111}

/* LOJAS */
.lojas-wrap{
  margin-top:14px;
}
.lojas-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:8px;
}
.lojas-header h4{font-size:14px}
.lojas-scroll{
  display:flex;
  gap:14px;
  overflow-x:auto;
  padding-bottom:6px;
  scrollbar-width:none;
}
.lojas-scroll::-webkit-scrollbar{display:none}

.loja-card{
  min-width:90px;
  text-align:center;
  cursor:pointer;
  animation:none;
}
.loja-card.editing{
  animation:shake .35s infinite;
}
@keyframes shake{
  0%{transform:rotate(-1deg)}
  50%{transform:rotate(1deg)}
  100%{transform:rotate(-1deg)}
}
.loja-logo{
  width:64px;height:64px;
  border-radius:50%;
  background:#eee;
  background-size:cover;
  background-position:center;
  margin:0 auto 6px;
  border:2px solid transparent;
}
.loja-card.active .loja-logo{
  border-color:var(--primary);
}
.loja-card span{
  font-size:11px;
  font-weight:600;
  display:block;
}

/* ADD */
.add-loja{
  min-width:64px;
  height:64px;
  border-radius:50%;
  border:1px dashed var(--border);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:26px;
  cursor:pointer;
}

/* CONFIRM */
#confirmOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:10000;
}
.confirm-box{
  background:#fff;
  padding:20px;
  border-radius:18px;
  width:80%;
  max-width:300px;
  text-align:center;
}
.confirm-box button{margin-top:10px}
  /* üõí CART BUTTON */
.cart-btn{
  position:relative;
  width:36px;
  height:36px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}

.cart-btn i{
  font-size:22px;
  color:var(--text);
}

.cart-badge{
  position:absolute;
  top:-4px;
  right:-6px;
  background:var(--primary);
  color:#fff;
  font-size:10px;
  font-weight:800;
  padding:2px 6px;
  border-radius:999px;
  min-width:18px;
  text-align:center;
  display:none;
}
.loja-card,
.loja-logo,
.loja-card * {
  pointer-events: auto;
}



  
</style>
</head>

<body>

<div class="topbar">
  <h1 id="nomeLoja">CLENA.COM.BR</h1>

  <div style="display:flex;align-items:center;gap:14px">

<div class="cart-btn" id="cartIcon" onclick="abrirCarrinho()">
  <i class="ri-shopping-cart-line"></i>
  <span id="cartCount" class="cart-badge">0</span>
</div>



    <!-- üë§ AVATAR -->
    <div class="avatar" id="avatar" onclick="openProfile()">A</div>

  </div>
</div>


<div class="content">
  <iframe id="frame"></iframe>
</div>

<nav class="navbar">
  <div class="nav-item active" onclick="go(this,'homeclientes.html')">
    <i class="ri-home-5-line"></i>In√≠cio
  </div>


  <div class="nav-item" onclick="go(this,'agendar.html')">
    <i class="ri-calendar-line"></i>Agendar
  </div>

  <div class="nav-item" onclick="go(this,'agendamentosclientes.html')">
    <i class="ri-user-line"></i>Meu espa√ßo
  </div>
</nav>


<!-- PROFILE -->
<div id="profileOverlay">
  <div class="profile-modal" onclick="event.stopPropagation()">

    <div class="profile-img" id="profileImg">
      <div class="cam" onclick="foto.click()"><i class="ri-camera-line"></i></div>
    </div>
    <input type="file" id="foto" hidden accept="image/*">

    <div class="field"><input id="pNome" placeholder="Nome"></div>
    <div class="field"><input id="pWhats" placeholder="WhatsApp"></div>

    <div class="row">
      <div class="field"><input id="pCep" placeholder="CEP"></div>
      <div class="field"><input id="pNumero" placeholder="N√∫mero"></div>
    </div>

    <div class="field"><input id="pRua" placeholder="Rua"></div>

    <div class="row">
      <div class="field"><input id="pCidade" placeholder="Cidade"></div>
      <div class="field"><input id="pUf" placeholder="UF"></div>
    </div>

    <button class="btn btn-primary" onclick="salvarPerfil()">Salvar</button>

    <!-- LOJAS -->
    <div class="lojas-wrap">
      <div class="lojas-header">
        <h4>Minhas lojas</h4>
      </div>
      <div class="lojas-scroll" id="lojasScroll"></div>
    </div>

    <button class="btn btn-danger" onclick="sair()">Sair</button>
  </div>
</div>

<!-- CONFIRM -->
<div id="confirmOverlay">
  <div class="confirm-box">
    <p>Remover esta loja?</p>
    <button class="btn btn-danger" onclick="confirmRemove()">Remover</button>
    <button class="btn btn-ghost" onclick="closeConfirm()">Cancelar</button>
  </div>
</div>

<script>
const sb = supabase.createClient(
  "https://egxjgmzukjyyxmkukwub.supabase.co",
  "sb_publishable_EWwdrLOUk6KDHZGLuh4uRg_QDRtLeFi"
);
async function verificarProdutosLoja(lojaId) {
  if (!lojaId) return;

  const { count, error } = await sb
    .from("produtos_servicos")
    .select("*", { count: "exact", head: true })
    .eq("user_id", lojaId)
    .eq("ativo", true)
    .eq("tipo", "PRODUTO");

  if (error) {
    console.error(error);
    return;
  }

 const nav = document.getElementById("navProdutos");
if (!nav) return;

if (count > 0) {
  nav.style.display = "flex";
} else {
  nav.style.display = "none";
}

}


const frame = document.getElementById("frame");
  
let user, perfil;
frame.addEventListener("load", () => {
  if (typeof atualizarBadgeCarrinho === "function") {
    atualizarBadgeCarrinho();
  }
});


(async () => {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) {
    location.href = "index.html";
    return;
  }

  user = session.user;

  const params = new URLSearchParams(location.search);
  let lojaId = params.get("l");

  // üîç busca perfil
  const { data: perfilDB } = await sb
    .from("clientes_profile")
    .select("*")
    .eq("id", user.id)
    .maybeSingle();

  // üî• cria perfil se n√£o existir
  if (!perfilDB) {
    const { data: criado } = await sb
      .from("clientes_profile")
      .insert({
        id: user.id,
        nome: user.user_metadata?.name || user.email,
        email: user.email,
        loja_ativa: lojaId
      })
      .select()
      .single();

    perfil = criado;
  } else {
    perfil = perfilDB;
  }

  // üîë fallback de loja
if (!lojaId && perfil.loja_ativa) {
  lojaId = perfil.loja_ativa;
  history.replaceState(null, "", `app.html?l=${lojaId}`);
}

if (lojaId) {
  localStorage.setItem("LOJA_ATUAL", lojaId);
}


  // üîÑ sincroniza loja ativa
  if (lojaId && lojaId !== perfil.loja_ativa) {
    await sb.from("clientes_loja").upsert({
      cliente_id: user.id,
      loja_id: lojaId
    });

    await sb.from("clientes_profile")
      .update({ loja_ativa: lojaId })
      .eq("id", user.id);

    perfil.loja_ativa = lojaId;
  }

  // üî• ATUALIZA NOME DA LOJA NO TOPO
  const { data: lojaTopo } = await sb
    .from("user_profile")
    .select("negocio")
    .eq("user_id", perfil.loja_ativa)
    .maybeSingle();

  if (lojaTopo?.negocio) {
    nomeLoja.innerText = lojaTopo.negocio;
  }

  // üñºÔ∏è carrega iframe inicial
  frame.src = `homeclientes.html?l=${perfil.loja_ativa}&t=${Date.now()}`;

  // üî• verifica se tem produtos
  verificarProdutosLoja(perfil.loja_ativa);

// üë§ carrega perfil
carregarPerfil();

// üî• GARANTE CLIENTE_LOJA SEMPRE DISPON√çVEL
sincronizarClienteLoja();

// üõí ATUALIZA BADGE DO CARRINHO
atualizarBadgeCarrinho();

})();

function carregarPerfil(){
  pNome.value = perfil.nome || "";
  pWhats.value = perfil.whatsapp || "";
  pCep.value = perfil.cep || "";
  pRua.value = perfil.rua || "";
  pNumero.value = perfil.numero || "";
  pCidade.value = perfil.cidade || "";
  pUf.value = perfil.uf || "";

  if (perfil.avatar_url) {
    avatar.style.backgroundImage = `url(${perfil.avatar_url})`;
    avatar.textContent = "";
    profileImg.style.backgroundImage = `url(${perfil.avatar_url})`;
  } else {
    avatar.textContent = (perfil.nome || "A")[0];
  }

  renderLojas();
}

async function renderLojas(){
  lojasScroll.innerHTML = "";

  const { data: lojas } = await sb
    .from("clientes_loja")
    .select(`
      loja_id,
      user_profile:loja_id (negocio, avatar_url)
    `)
    .eq("cliente_id", user.id)
    .order("updated_at", { ascending: false })
    .limit(5);

  const lojaAtual = new URLSearchParams(location.search).get("l");

  for (const l of lojas || []) {
    const div = document.createElement("div");
    div.className = "loja-card" + (l.loja_id === lojaAtual ? " active" : "");
    div.innerHTML = `
      <div class="loja-logo" style="background-image:url('${l.user_profile?.avatar_url || ""}')"></div>
      <span>${l.user_profile?.negocio || "Loja"}</span>
    `;
div.addEventListener("click", (e) => {
  e.preventDefault();
  e.stopPropagation();
  trocarLoja(l.loja_id);
});
    lojasScroll.appendChild(div);
  }

  lojasScroll.innerHTML += `
    <div class="add-loja" onclick="location.href='lojasat.html?from=app'">+</div>
  `;
}
async function trocarLoja(lojaId){
  // fecha modal
  profileOverlay.style.display = "none";

  // loja atual
  const lojaAtual = new URLSearchParams(location.search).get("l");

  // evita reload desnecess√°rio
  if(lojaAtual === lojaId) return;

  // üî• limpa carrinho da loja anterior
  if (lojaAtual) {
    localStorage.removeItem("carrinho_" + lojaAtual);
  }

  // üîÑ salva loja ativa
  await sb.from("clientes_loja").upsert({
    cliente_id: user.id,
    loja_id: lojaId
  });

  await sb.from("clientes_profile")
    .update({ loja_ativa: lojaId })
    .eq("id", user.id);

  perfil.loja_ativa = lojaId;

  // üî• atualiza URL (fonte da verdade)
  history.replaceState(null, "", `app.html?l=${lojaId}`);

  // üî• atualiza nome da loja no topo
  const { data: novaLoja } = await sb
    .from("user_profile")
    .select("negocio")
    .eq("user_id", lojaId)
    .maybeSingle();

  if(novaLoja?.negocio){
    nomeLoja.innerText = novaLoja.negocio;
  }

  // üî• for√ßa reload REAL do iframe
  frame.src = "about:blank";
  setTimeout(() => {
    frame.src = `homeclientes.html?l=${lojaId}&t=${Date.now()}`;
  }, 50);

  // üî• recalcula menus e estado
  verificarProdutosLoja(lojaId);
  atualizarBadgeCarrinho();
  renderLojas();
}



function sincronizarClienteLoja() {
  if (!perfil || !user) {
    console.warn("Perfil ou usu√°rio ainda n√£o carregado");
    return;
  }

  const clienteLoja = {
    id: user.id,
    nome: perfil.nome || "",
    whatsapp: perfil.whatsapp || "",
    cep: perfil.cep || "",
    rua: perfil.rua || "",
    numero: perfil.numero || "",
    cidade: perfil.cidade || "",
    uf: perfil.uf || ""
  };

  localStorage.setItem("CLIENTE_LOJA", JSON.stringify(clienteLoja));
}






  
function go(el,p){
  document.querySelectorAll(".nav-item").forEach(i=>i.classList.remove("active"));
  el.classList.add("active");

  // üî• SE FOR A LOJA, SINCRONIZA O PERFIL
  if (p === "lojacliente.html") {
    sincronizarClienteLoja();
  }

  const lojaId = new URLSearchParams(location.search).get("l");
  frame.src = `${p}?l=${lojaId}&t=${Date.now()}`;
}


function openProfile(){ profileOverlay.style.display="flex"; }
function closeProfile(e){ if(!e || e.target.id==="profileOverlay") profileOverlay.style.display="none"; }
async function sair(){ await sb.auth.signOut(); location.href="index.html"; }
  async function salvarPerfil(){
  const dados = {
    nome: pNome.value.trim(),
    whatsapp: pWhats.value.trim(),
    cep: pCep.value.trim(),
    rua: pRua.value.trim(),
    numero: pNumero.value.trim(),
    cidade: pCidade.value.trim(),
    uf: pUf.value.trim()
  };

  const { error } = await sb
    .from("clientes_profile")
    .update(dados)
    .eq("id", user.id);

  if(error){
    alert("Erro ao salvar perfil");
    console.error(error);
    return;
  }

  // Atualiza mem√≥ria local
  Object.assign(perfil, dados);

  // Atualiza avatar inicial
  avatar.textContent = (perfil.nome || "A")[0];

  profileOverlay.style.display = "none";
}
let lojaParaRemover = null;

function openConfirm(lojaId){
  lojaParaRemover = lojaId;
  confirmOverlay.style.display = "flex";
}

function closeConfirm(){
  confirmOverlay.style.display = "none";
  lojaParaRemover = null;
}

async function confirmRemove(){
  if(!lojaParaRemover) return;

  await sb
    .from("clientes_loja")
    .delete()
    .eq("cliente_id", user.id)
    .eq("loja_id", lojaParaRemover);

  closeConfirm();
  renderLojas();
}
foto.addEventListener("change", async () => {
  const file = foto.files[0];
  if (!file) return;

  // valida√ß√£o simples
  if (!file.type.startsWith("image/")) {
    alert("Selecione uma imagem");
    return;
  }

  const ext = file.name.split(".").pop();
  const filePath = `${user.id}.${ext}`;

  // upload
  const { error: uploadError } = await sb.storage
    .from("avatars")
    .upload(filePath, file, {
      upsert: true,
      cacheControl: "3600"
    });

  if (uploadError) {
    console.error(uploadError);
    alert("Erro ao enviar foto");
    return;
  }

  // url p√∫blica
  const { data } = sb.storage
    .from("avatars")
    .getPublicUrl(filePath);

  const avatarUrl = data.publicUrl;

  // salva no perfil
  const { error: updateError } = await sb
    .from("clientes_profile")
    .update({ avatar_url: avatarUrl })
    .eq("id", user.id);

  if (updateError) {
    console.error(updateError);
    alert("Erro ao salvar foto");
    return;
  }

  // atualiza UI imediatamente
  perfil.avatar_url = avatarUrl;
  avatar.style.backgroundImage = `url(${avatarUrl})`;
  avatar.textContent = "";
  profileImg.style.backgroundImage = `url(${avatarUrl})`;
});

</script>
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/firebase-messaging-sw.js")
    .then(reg => {
      console.log("Service Worker registrado:", reg.scope);
    })
    .catch(err => {
      console.error("Erro ao registrar Service Worker", err);
    });
}
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js";

const firebaseConfig = {
  apiKey: "AIzaSyC_xFOKDqXRe1r-sjj-Juo6-nDfYceICTI",
  authDomain: "agenda-facil-77785.firebaseapp.com",
  projectId: "agenda-facil-77785",
  storageBucket: "agenda-facil-77785.appspot.com",
  messagingSenderId: "1029015721724",
  appId: "1:1029015721724:web:980a9f6e0cebd702976979"
};

const app = initializeApp(firebaseConfig);
const messaging = getMessaging(app);

// üîî pedir permiss√£o corretamente
(async () => {
  let permission = Notification.permission;

  if (permission !== "granted") {
    permission = await Notification.requestPermission();
  }

  if (permission === "granted") {

    const token = await getToken(messaging, {
      vapidKey: "BOnsk8qbaS02uThkpNsVu-jDMctwMHqzPfy5ruJfJpuH31Tv3XJf7lZrZd7u_wYxvqVo4XxM6E8MW3DWEyQVocE"
    });

    console.log("FCM TOKEN:", token);

    const { data: { session } } = await sb.auth.getSession();

    if (session && token) {
      await sb.from("notificacoes_tokens").upsert({
        user_id: session.user.id,
        token: token,
        plataforma: "apk"
      });
    }
  }
})();


// üîî quando o app estiver aberto
onMessage(messaging, payload => {
  alert(payload.notification.title + "\n" + payload.notification.body);
});




function getCarrinhoQuantidade(){
  const lojaId =
    new URLSearchParams(location.search).get("l") ||
    localStorage.getItem("LOJA_ATUAL");

  if(!lojaId) return 0;

  const carrinho = JSON.parse(
    localStorage.getItem("carrinho_" + lojaId) || "[]"
  );

  return carrinho.reduce((s,i)=>s + (i.quantidade || 1), 0);
}

function atualizarBadgeCarrinho(){
  const qtd = getCarrinhoQuantidade();
  const badge = document.getElementById("cartCount");

  if(!badge) return;

  if(qtd > 0){
    badge.innerText = qtd > 99 ? "99+" : qtd;
    badge.style.display = "inline-block";
  }else{
    badge.style.display = "none";
  }
}

function abrirCarrinho(){
  const lojaId =
    new URLSearchParams(location.search).get("l") ||
    localStorage.getItem("LOJA_ATUAL");

  if(!lojaId){
    alert("Loja n√£o identificada");
    return;
  }

  frame.src = `carrinho.html?l=${lojaId}&t=${Date.now()}`;
}

/* üî• EXP√ïE FUN√á√ïES PARA O IFRAME */
window.abrirCarrinho = abrirCarrinho;
window.atualizarBadgeCarrinho = atualizarBadgeCarrinho;
/* üî• AQUI ‚Äî FORA DE FUN√á√ïES */
setInterval(() => {
  if (typeof atualizarBadgeCarrinho === "function") {
    atualizarBadgeCarrinho();
  }
}, 1000);



window.animarCarrinhoTopo = function(){
  const cart = document.getElementById("cartIcon");
  if(!cart) return;

  cart.animate([
    { transform: "scale(1)" },
    { transform: "scale(1.25)" },
    { transform: "scale(1)" }
  ], {
    duration: 400,
    easing: "cubic-bezier(.22,.61,.36,1)"
  });
};
window.addEventListener("popstate", () => {
  const lojaId = new URLSearchParams(location.search).get("l");
  if(!lojaId) return;

  frame.src = "about:blank";
  setTimeout(() => {
    frame.src = `homeclientes.html?l=${lojaId}&t=${Date.now()}`;
  }, 50);

  verificarProdutosLoja(lojaId);
  atualizarBadgeCarrinho();
  renderLojas();
});

profileOverlay.addEventListener("click", (e) => {
  if (e.target === profileOverlay) {
    profileOverlay.style.display = "none";
  }
});






  

</script>


</body>
</html>
