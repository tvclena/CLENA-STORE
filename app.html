<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-T97MS35TJ6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-T97MS35TJ6');
</script>
<title>App cliente</title>

<meta name="viewport"
  content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">

<meta name="theme-color" content="#ff6a00">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primary:#ff6a00;
  --bg:#f4f6fb;
  --border:#e5e7eb;
  --text:#111827;
  --muted:#6b7280;
  --danger:#dc2626;
  --topbar-h:56px;
  --navbar-h:68px;
}

*{margin:0;padding:0;box-sizing:border-box;font-family:Inter}
html,body{width:100%;height:100%;background:var(--bg);overflow:hidden}

/* TOPBAR */
.topbar{
  position:fixed;top:0;left:0;right:0;
  height:var(--topbar-h);
  background:#fff;
  border-bottom:1px solid var(--border);
  padding:0 16px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  z-index:10;
}
.topbar h1{font-size:18px;font-weight:800}

/* AVATAR */
.avatar{
  width:36px;height:36px;border-radius:50%;
  background:linear-gradient(135deg,#ff6a00,#ff9a57);
  display:flex;align-items:center;justify-content:center;
  color:#fff;font-weight:800;
  cursor:pointer;
  background-size:cover;
  background-position:center;
}

/* CONTENT */
.content{
  position:fixed;
  top:var(--topbar-h);
  bottom:var(--navbar-h);
  left:0;right:0;
  background:#fff;
}
iframe{width:100%;height:100%;border:none}

/* NAVBAR */
.navbar{
  position:fixed;
  bottom:0;left:0;right:0;
  height:var(--navbar-h);
  background:#fff;
  border-top:1px solid var(--border);
  display:flex;
  justify-content:space-around;
  align-items:center;
}
.nav-item{
  font-size:11px;
  color:var(--muted);
  display:flex;
  flex-direction:column;
  align-items:center;
  cursor:pointer;
}
.nav-item i{font-size:22px}
.nav-item.active{color:var(--primary)}

/* PROFILE OVERLAY */
#profileOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

/* PROFILE MODAL */
.profile-modal{
  width:92%;
  max-width:420px;
  background:#fff;
  border-radius:26px;
  padding:20px;
  max-height:90vh;
  overflow:auto;
  scrollbar-width:none;
}
.profile-modal::-webkit-scrollbar{display:none}

/* PROFILE IMG */
.profile-img{
  width:90px;height:90px;border-radius:50%;
  background:#eee;
  background-size:cover;
  background-position:center;
  margin:0 auto 12px;
  position:relative;
}
.profile-img .cam{
  position:absolute;
  right:-4px;bottom:-4px;
  width:34px;height:34px;
  border-radius:50%;
  background:linear-gradient(135deg,#ff6a00,#ff9a57);
  display:flex;align-items:center;justify-content:center;
  color:#fff;
  border:3px solid #fff;
  cursor:pointer;
}

/* FIELDS */
.field{margin-bottom:10px}
.field input{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid var(--border);
}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}

/* BUTTONS */
.btn{
  width:100%;
  padding:14px;
  border:none;
  border-radius:999px;
  font-weight:800;
  cursor:pointer;
}
.btn-primary{background:var(--primary);color:#fff}
.btn-danger{background:#fee2e2;color:var(--danger)}
.btn-ghost{background:#f3f4f6;color:#111}

/* LOJAS */
.lojas-wrap{
  margin-top:14px;
}
.lojas-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:8px;
}
.lojas-header h4{font-size:14px}
.lojas-scroll{
  display:flex;
  gap:14px;
  overflow-x:auto;
  padding-bottom:6px;
  scrollbar-width:none;
}
.lojas-scroll::-webkit-scrollbar{display:none}

.loja-card{
  min-width:90px;
  text-align:center;
  cursor:pointer;
  animation:none;
}
.loja-card.editing{
  animation:shake .35s infinite;
}
@keyframes shake{
  0%{transform:rotate(-1deg)}
  50%{transform:rotate(1deg)}
  100%{transform:rotate(-1deg)}
}
.loja-logo{
  width:64px;height:64px;
  border-radius:50%;
  background:#eee;
  background-size:cover;
  background-position:center;
  margin:0 auto 6px;
  border:2px solid transparent;
}
.loja-card.active .loja-logo{
  border-color:var(--primary);
}
.loja-card span{
  font-size:11px;
  font-weight:600;
  display:block;
}

/* ADD */
.add-loja{
  min-width:64px;
  height:64px;
  border-radius:50%;
  border:1px dashed var(--border);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:26px;
  cursor:pointer;
}

/* CONFIRM */
#confirmOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:10000;
}
.confirm-box{
  background:#fff;
  padding:20px;
  border-radius:18px;
  width:80%;
  max-width:300px;
  text-align:center;
}
.confirm-box button{margin-top:10px}
</style>
</head>

<body>

<div class="topbar">
  <h1 id="nomeLoja">Agenda F√°cil</h1>
  <div class="avatar" id="avatar" onclick="openProfile()">A</div>
</div>

<div class="content">
  <iframe id="frame"></iframe>
</div>

<nav class="navbar">
  <div class="nav-item active" onclick="go(this,'homeclientes.html')"><i class="ri-home-5-line"></i>In√≠cio</div>
  <div class="nav-item" onclick="go(this,'agendar.html')"><i class="ri-calendar-line"></i>Agendar</div>
  <div class="nav-item" onclick="go(this,'agendamentosclientes.html')"><i class="ri-user-line"></i>Meu espa√ßo</div>
</nav>

<!-- PROFILE -->
<div id="profileOverlay" onclick="closeProfile(event)">
  <div class="profile-modal" onclick="event.stopPropagation()">

    <div class="profile-img" id="profileImg">
      <div class="cam" onclick="foto.click()"><i class="ri-camera-line"></i></div>
    </div>
    <input type="file" id="foto" hidden accept="image/*">

    <div class="field"><input id="pNome" placeholder="Nome"></div>
    <div class="field"><input id="pWhats" placeholder="WhatsApp"></div>

    <div class="row">
      <div class="field"><input id="pCep" placeholder="CEP"></div>
      <div class="field"><input id="pNumero" placeholder="N√∫mero"></div>
    </div>

    <div class="field"><input id="pRua" placeholder="Rua"></div>

    <div class="row">
      <div class="field"><input id="pCidade" placeholder="Cidade"></div>
      <div class="field"><input id="pUf" placeholder="UF"></div>
    </div>

    <button class="btn btn-primary" onclick="salvarPerfil()">Salvar</button>

    <!-- LOJAS -->
    <div class="lojas-wrap">
      <div class="lojas-header">
        <h4>Minhas lojas</h4>
      </div>
      <div class="lojas-scroll" id="lojasScroll"></div>
    </div>

    <button class="btn btn-danger" onclick="sair()">Sair</button>
  </div>
</div>

<!-- CONFIRM -->
<div id="confirmOverlay">
  <div class="confirm-box">
    <p>Remover esta loja?</p>
    <button class="btn btn-danger" onclick="confirmRemove()">Remover</button>
    <button class="btn btn-ghost" onclick="closeConfirm()">Cancelar</button>
  </div>
</div>

<script>
const sb = supabase.createClient(
  "https://egxjgmzukjyyxmkukwub.supabase.co",
  "sb_publishable_EWwdrLOUk6KDHZGLuh4uRg_QDRtLeFi"
);

const frame=document.getElementById("frame");
let user,perfil,edit=false,removeId=null;


  
(async () => {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) {
    location.href = "index.html";
    return;
  }

  user = session.user;

  const params = new URLSearchParams(location.search);
  let lojaId = params.get("l");

  // üîç busca perfil
  const { data: perfilDB } = await sb
    .from("clientes_profile")
    .select("*")
    .eq("id", user.id)
    .maybeSingle();

  // üî• cria perfil se n√£o existir
  if (!perfilDB) {
    const { data: criado } = await sb
      .from("clientes_profile")
      .insert({
        id: user.id,
        nome: user.user_metadata?.name || user.email,
        email: user.email,
        loja_ativa: lojaId
      })
      .select()
      .single();

    perfil = criado;
  } else {
    perfil = perfilDB;
  }

  // üîë fallback de loja
  if (!lojaId && perfil.loja_ativa) {
    lojaId = perfil.loja_ativa;
    history.replaceState(null, "", `app.html?l=${lojaId}`);
  }
// üö® se ainda n√£o houver loja, for√ßa ir para sele√ß√£o
if (!lojaId) {
  location.href = "lojasat.html";
  return;
}

  // üîÑ sincroniza loja ativa
  if (lojaId && lojaId !== perfil.loja_ativa) {
    await sb.from("clientes_loja").upsert({
      cliente_id: user.id,
      loja_id: lojaId
    });

    await sb.from("clientes_profile")
      .update({ loja_ativa: lojaId })
      .eq("id", user.id);

    perfil.loja_ativa = lojaId;
  }

  // üñºÔ∏è carrega iframe
  frame.src = `homeclientes.html?l=${perfil.loja_ativa}&t=${Date.now()}`;

  carregarPerfil();
})();


function carregarPerfil(){
  pNome.value=perfil.nome||"";
  pWhats.value=perfil.whatsapp||"";
  pCep.value=perfil.cep||"";
  pRua.value=perfil.rua||"";
  pNumero.value=perfil.numero||"";
  pCidade.value=perfil.cidade||"";
  pUf.value=perfil.uf||"";

  if(perfil.avatar_url){
    avatar.style.backgroundImage=`url(${perfil.avatar_url})`;
    avatar.textContent="";
    profileImg.style.backgroundImage=`url(${perfil.avatar_url})`;
  }else avatar.textContent=(perfil.nome||"A")[0];

  renderLojas();
}

async function renderLojas(){
  lojasScroll.innerHTML = "";

  const { data: lojas } = await sb
    .from("clientes_loja")
    .select(`
      loja_id,
      user_profile:loja_id (negocio, avatar_url)
    `)
    .eq("cliente_id", user.id)
    .order("updated_at", { ascending: false })
    .limit(5);

  const idsRenderizados = new Set();

  for(const l of lojas || []){
    if(idsRenderizados.has(l.loja_id)) continue;
    idsRenderizados.add(l.loja_id);

    const div = document.createElement("div");
    div.className = "loja-card" + (l.loja_id === perfil.loja_ativa ? " active" : "");
    div.innerHTML = `
      <div class="loja-logo" style="background-image:url('${l.user_profile?.avatar_url || ""}')"></div>
      <span>${l.user_profile?.negocio || "Loja"}</span>
    `;
    div.onclick = () => trocarLoja(l.loja_id);
    lojasScroll.appendChild(div);
  }

  // bot√£o +
  lojasScroll.innerHTML += `
    <div class="add-loja" onclick="location.href='lojasat.html?from=app'">+</div>
  `;
}


function toggleEdit(){
  edit=!edit;
  renderLojas();
}

async function trocarLoja(lojaId){
  // salva como recente (n√£o duplica)
  await sb.from("clientes_loja").upsert({
    cliente_id: user.id,
    loja_id: lojaId
  });

  // atualiza loja ativa no banco
  await sb.from("clientes_profile")
    .update({ loja_ativa: lojaId })
    .eq("id", user.id);

  // üî• ATUALIZA EM MEM√ìRIA (ESSENCIAL)
  perfil.loja_ativa = lojaId;

  // atualiza URL
  history.replaceState(null, "", `app.html?l=${lojaId}`);

  // üî• FOR√áA RELOAD DO IFRAME
  frame.src = `homeclientes.html?l=${lojaId}&t=${Date.now()}`;

  // re-renderiza as lojas (active correto)
  renderLojas();
}


async function confirmRemove(){
  perfil.lojas=perfil.lojas.filter(l=>l!==removeId);
  if(perfil.loja_ativa===removeId) perfil.loja_ativa=perfil.lojas[0]||null;
  await sb.from("clientes_profile").update({
    lojas:perfil.lojas,
    loja_ativa:perfil.loja_ativa
  }).eq("id",user.id);
  closeConfirm();
  location.reload();
}

function closeConfirm(){confirmOverlay.style.display="none";removeId=null}

async function salvarPerfil(){
  let avatarUrl=perfil.avatar_url;
  if(foto.files.length){
    const path=`perfil/${user.id}.jpg`;
    await sb.storage.from("avatars").upload(path,foto.files[0],{upsert:true});
    avatarUrl=sb.storage.from("avatars").getPublicUrl(path).data.publicUrl;
  }
  await sb.from("clientes_profile").update({
    nome:pNome.value,whatsapp:pWhats.value,cep:pCep.value,
    rua:pRua.value,numero:pNumero.value,cidade:pCidade.value,uf:pUf.value,
    avatar_url:avatarUrl
  }).eq("id",user.id);
  location.reload();
}

function openProfile(){profileOverlay.style.display="flex"}
function closeProfile(e){if(!e||e.target.id==="profileOverlay")profileOverlay.style.display="none"}
async function sair(){await sb.auth.signOut();location.href="index.html"}
function go(el,p){
  document.querySelectorAll(".nav-item").forEach(i=>i.classList.remove("active"));
  el.classList.add("active");

  const params = new URLSearchParams(location.search);
  const lojaId = params.get("l") || perfil.loja_ativa;

frame.src = `${p}?l=${lojaId}&t=${Date.now()}`;
}
</script>

</body>
</html>
