<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Agenda Fácil</title>

<link rel="manifest" href="/manifest.json">

<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="theme-color" content="#ff6a00">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primary:#ff6a00;
  --primary-soft:rgba(255,106,0,.14);
  --bg:#f4f6fb;
  --border:#e5e7eb;
  --text:#111827;
  --muted:#6b7280;
  --danger:#dc2626;
  --topbar-h:56px;
  --navbar-h:68px;
}
*{box-sizing:border-box;font-family:Inter}
html,body{margin:0;width:100%;height:100%;background:var(--bg);overflow:hidden}

/* TOPBAR */
.topbar{
  position:fixed;top:0;left:0;right:0;
  height:var(--topbar-h);
  background:#fff;
  border-bottom:1px solid var(--border);
  padding:0 16px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  z-index:10;
}
.topbar h1{font-size:18px;font-weight:800}

/* AVATAR */
.avatar{
  width:36px;height:36px;border-radius:50%;
  background:linear-gradient(135deg,#ff6a00,#ff9a57);
  display:flex;align-items:center;justify-content:center;
  color:#fff;font-weight:800;
  cursor:pointer;
  background-size:cover;
  background-position:center;
}

/* CONTENT */
.content{
  position:fixed;
  top:var(--topbar-h);
  bottom:var(--navbar-h);
  left:0;right:0;
  background:#fff;
}
iframe{width:100%;height:100%;border:none}

/* NAVBAR */
.navbar{
  position:fixed;
  bottom:0;left:0;right:0;
  height:var(--navbar-h);
  background:#fff;
  border-top:1px solid var(--border);
  display:flex;
  justify-content:space-around;
  align-items:center;
}
.nav-item{
  font-size:11px;
  color:var(--muted);
  display:flex;
  flex-direction:column;
  align-items:center;
  cursor:pointer;
}
.nav-item i{font-size:22px}
.nav-item.active{color:var(--primary)}

/* OVERLAY */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:flex-end;
  z-index:9999;
}

/* PROFILE */
.profile-box{
  width:100%;
  background:#fff;
  border-radius:22px 22px 0 0;
  padding:18px;
  max-height:92vh;
  overflow:auto;
}
.profile-img{
  width:86px;height:86px;border-radius:50%;
  background:#eee;
  background-size:cover;
  background-position:center;
  margin:0 auto;
  position:relative;
}
.profile-img .cam{
  position:absolute;
  right:-4px;bottom:-4px;
  width:34px;height:34px;
  border-radius:50%;
  background:linear-gradient(135deg,#ff6a00,#ff9a57);
  display:flex;align-items:center;justify-content:center;
  color:#fff;
  border:3px solid #fff;
}
.field{margin-bottom:10px}
.field input{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid var(--border);
}
.btn{
  width:100%;
  padding:14px;
  border:none;
  border-radius:999px;
  font-weight:800;
  cursor:pointer;
}
.btn-primary{background:var(--primary);color:#fff}
.btn-danger{background:#fee2e2;color:var(--danger);margin-top:8px}

/* MINHAS LOJAS */
.lojas-list{
  display:flex;
  flex-direction:column;
  gap:8px;
  margin-top:10px;
}
.loja-item{
  padding:12px;
  border-radius:14px;
  border:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  cursor:pointer;
}
.loja-item.active{border-color:var(--primary)}
</style>
</head>

<body>

<div class="topbar">
  <h1 id="nomeLoja">Agenda Fácil</h1>
  <div class="avatar" id="avatar" onclick="openProfile()">A</div>
</div>

<div class="content">
  <iframe id="frame"></iframe>
</div>

<nav class="navbar">
  <div class="nav-item active" onclick="go(this,'homeclientes.html')"><i class="ri-home-5-line"></i>Início</div>
  <div class="nav-item" onclick="go(this,'agendar.html')"><i class="ri-calendar-line"></i>Agendar</div>
  <div class="nav-item" onclick="go(this,'agendamentosclientes.html')"><i class="ri-user-line"></i>Meu espaço</div>
</nav>

<!-- PROFILE -->
<div class="overlay" id="profileModal" onclick="closeProfile(event)">
  <div class="profile-box" onclick="event.stopPropagation()">

    <div class="profile-img" id="profileImg">
      <div class="cam" onclick="foto.click()"><i class="ri-camera-line"></i></div>
    </div>
    <input type="file" id="foto" hidden accept="image/*">

    <div class="field"><input id="pNome" placeholder="Nome"></div>
    <div class="field"><input id="pWhats" placeholder="WhatsApp"></div>
    <div class="field"><input id="pCep" placeholder="CEP"></div>
    <div class="field"><input id="pRua" placeholder="Rua"></div>
    <div class="field"><input id="pNumero" placeholder="Número"></div>
    <div class="field"><input id="pCidade" placeholder="Cidade"></div>
    <div class="field"><input id="pUf" placeholder="UF"></div>

    <button class="btn btn-primary" onclick="salvarPerfil()">Salvar</button>

    <h4 style="margin-top:14px">Minhas lojas</h4>
    <div class="lojas-list" id="listaLojas"></div>

    <button class="btn" onclick="location.href='lojasat.html'" style="margin-top:10px">
      <i class="ri-store-2-line"></i> +
    </button>

    <button class="btn btn-danger" onclick="sair()">Sair</button>
  </div>
</div>

<script>
const sb = supabase.createClient(
  "https://egxjgmzukjyyxmkukwub.supabase.co",
  "sb_publishable_EWwdrLOUk6KDHZGLuh4uRg_QDRtLeFi"
);

const lojaId = new URLSearchParams(location.search).get("l");
const frame = document.getElementById("frame");

let user, perfil;

/* INIT */
(async()=>{
  const { data:{session} } = await sb.auth.getSession();
  if(!session){ location.href=`index.html?l=${lojaId}`; return; }
  user = session.user;

  const { data:p } = await sb.from("clientes_profile").select("*").eq("id",user.id).single();
  perfil = p;

  frame.src = `homeclientes.html?l=${perfil.loja_ativa || lojaId}`;

  carregarPerfil();
})();

function carregarPerfil(){
  if(perfil.avatar_url){
    avatar.style.backgroundImage = `url(${perfil.avatar_url})`;
    avatar.textContent="";
    profileImg.style.backgroundImage = `url(${perfil.avatar_url})`;
  }else{
    avatar.textContent = perfil.nome?.[0] || "A";
  }

  pNome.value = perfil.nome || "";
  pWhats.value = perfil.whatsapp || "";
  pCep.value = perfil.cep || "";
  pRua.value = perfil.rua || "";
  pNumero.value = perfil.numero || "";
  pCidade.value = perfil.cidade || "";
  pUf.value = perfil.uf || "";

  renderLojas();
}

function renderLojas(){
  listaLojas.innerHTML = "";
  (perfil.lojas || []).forEach(l=>{
    const div = document.createElement("div");
    div.className = "loja-item" + (l===perfil.loja_ativa?" active":"");
    div.innerHTML = `<span>${l}</span><span>Entrar</span>`;
    div.onclick = async ()=>{
      await sb.from("clientes_profile").update({loja_ativa:l}).eq("id",user.id);
      location.href = `app.html?l=${l}`;
    };
    listaLojas.appendChild(div);
  });
}

async function salvarPerfil(){
  let avatarUrl = perfil.avatar_url;

  if(foto.files.length){
    const path = `perfil/${user.id}.jpg`;
    await sb.storage.from("avatars").upload(path,foto.files[0],{upsert:true});
    avatarUrl = sb.storage.from("avatars").getPublicUrl(path).data.publicUrl;
  }

  await sb.from("clientes_profile").update({
    nome:pNome.value,
    whatsapp:pWhats.value,
    cep:pCep.value,
    rua:pRua.value,
    numero:pNumero.value,
    cidade:pCidade.value,
    uf:pUf.value,
    avatar_url:avatarUrl
  }).eq("id",user.id);

  location.reload();
}

function go(el,page){
  document.querySelectorAll(".nav-item").forEach(i=>i.classList.remove("active"));
  el.classList.add("active");
  frame.src = `${page}?l=${perfil.loja_ativa}`;
}

function openProfile(){ profileModal.style.display="flex"; }
function closeProfile(e){ if(!e || e.target.id==="profileModal") profileModal.style.display="none"; }

async function sair(){
  await sb.auth.signOut();
  location.href = `index.html?l=${lojaId}`;
}
</script>

</body>
</html>
