<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-T97MS35TJ6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-T97MS35TJ6');
</script>
<title>Home - Clientes</title>

  
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<script>
(function(){
  const params = new URLSearchParams(location.search);
  const lojaId = params.get("l");
  if(!lojaId) return;

  const tema = localStorage.getItem("loja_tema_" + lojaId);
  if(!tema) return;

  try{
    const cfg = JSON.parse(tema);
    const root = document.documentElement;

    if(cfg.primary) root.style.setProperty("--primary", cfg.primary);
    if(cfg.secondary) root.style.setProperty("--primary-2", cfg.secondary);
    if(cfg.text) root.style.setProperty("--text", cfg.text);
  }catch(e){}
})();
</script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  
:root{
  --primary: var(--primary, #ff6a00);
  --primary-2: var(--primary-2, #ff9a57);
  --bg:#f4f6fb;
  --card:#ffffff;
  --border:#e5e7eb;
  --text: var(--text, #111827);
  --muted:#6b7280;
}


*{box-sizing:border-box;font-family:Inter}
body{margin:0;background:var(--bg);padding:16px}

/* ================= BANNER ================= */
.banner{
  position: relative; /* üëà ESSENCIAL */
  background:linear-gradient(135deg,var(--primary),var(--primary-2));
  border-radius:22px;
  padding:18px;
  color:#fff;
}
.banner{
  overflow: hidden;
}


.banner-top{
  display:flex;
  gap:14px;
  align-items:center;
}

.banner-logo{
  width:120px;
  height:120px;
  min-width:120px;
  border-radius:18px;
  background:#fff;
  overflow:hidden;
  display:flex;
  align-items:center;
  justify-content:center;
}

.banner-logo img{
  width:100%;
  height:100%;
  object-fit:cover;
}

.banner h1{font-size:18px;font-weight:800}
.banner p{font-size:13px;opacity:.9}

.banner-chips{
  display:flex;
  gap:8px;
  margin-top:12px;
  flex-wrap:wrap;
}

.chip{
  background:rgba(255,255,255,.2);
  padding:6px 12px;
  border-radius:999px;
  font-size:12px;
}

/* ================= SEARCH ================= */
.search{margin:16px 0}
.search input{
  width:100%;
  padding:14px 16px;
  border-radius:14px;
  border:1px solid var(--border);
}

/* ================= TABS ================= */
.tabs{
  display:flex;
  gap:8px;
  margin-bottom:14px;
}

.tabs button{
  padding:10px 18px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#fff;
  font-weight:800;
  cursor:pointer;
}

.tabs button.active{
  background:var(--primary);
  color:#fff;
  border-color:var(--primary);
}

/* ================= GRID ================= */
.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:14px;
}
/* TABLET */
@media (min-width: 768px){
  .grid{
    grid-template-columns: repeat(3, 1fr);
  }
}

/* DESKTOP */
@media (min-width: 1200px){
  .grid{
    grid-template-columns: repeat(6, 1fr);
  }
}

.card{
  background:var(--card);
  border-radius:18px;
  overflow:hidden;
  box-shadow:0 10px 30px rgba(0,0,0,.08);
}

.card img{
  width:100%;
  height:120px;
  object-fit:cover;
}

.badge{
  position:absolute;
  top:10px;
  left:10px;
  background:var(--primary);
  color:#fff;
  padding:6px 10px;
  border-radius:999px;
  font-size:11px;
  font-weight:800;
}

.card-body{padding:12px}

.card-body strong{
  display:block;
  margin-bottom:6px;
}

.meta{
  display:flex;
  justify-content:space-between;
  font-size:12px;
  color:var(--muted);
  margin-bottom:10px;
}

.price{font-weight:900}

.old{
  text-decoration:line-through;
  color:#9ca3af;
  margin-right:6px;
}

.card button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:999px;
  background:var(--primary);
  color:#fff;
  font-weight:900;
  cursor:pointer;
}
.loja-titulo{
  display:flex;
  align-items:center;
  gap:10px;
}

.loja-titulo a{
  display:flex;
  align-items:center;
  justify-content:center;
  text-decoration:none;
}

.loja-titulo i{
  font-size:22px;
  color:#25D366;
  transition:.2s;
}

.loja-titulo a:hover i{
  transform:scale(1.15);
}
/* ================= MODAL PRODUTO ================= */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
  padding:16px;
}

.modal-box{
  background:#fff;
  border-radius:22px;
  width:100%;
  max-width:860px;
  max-height:90vh;
  overflow:hidden;
  display:flex;
  flex-direction:row;
  box-shadow:0 25px 60px rgba(0,0,0,.25);
}

/* IMAGEM */
.modal-img{
  width:45%;
  background:#f3f4f6;
}
.modal-img img{
  width:100%;
  height:100%;
  object-fit:cover;
}

/* CONTE√öDO */
.modal-content{
  width:55%;
  padding:20px;
  overflow-y:auto;
}

.modal-content h2{
  margin:0 0 6px;
  font-size:20px;
  font-weight:800;
}

.modal-content p{
  font-size:14px;
  color:#555;
  line-height:1.4;
}

/* PRE√áO */
.modal-preco{
  font-size:18px;
  font-weight:900;
  color:var(--primary);
  margin:10px 0;
}

/* BOT√ïES */
.modal-actions{
  display:flex;
  gap:10px;
  margin-top:14px;
}
.modal-actions .btn,
.modal-actions .btn-sec{
  flex:1;
  padding:12px;
  font-size:14px;
}

/* MOBILE */
@media(max-width:768px){
  .modal-box{
    flex-direction:column;
    max-width:420px;
  }

  .modal-img{
    width:100%;
    height:220px;
  }

  .modal-content{
    width:100%;
    padding:16px;
  }

  .modal-content h2{
    font-size:17px;
  }

  .modal-preco{
    font-size:16px;
  }

  .modal-actions{
    flex-direction:column;
  }
}

.btn-sec{
  width:100%;
  padding:12px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#fff;
  font-weight:700;
  cursor:pointer;
}
.btn{
  width:100%;
  padding:12px;
  border:none;
  border-radius:999px;
  background:var(--primary);
  color:#fff;
  font-weight:900;
  cursor:pointer;
}
/* ===== AVALIA√á√ïES ===== */
.avaliacao-item{
  display:flex;
  gap:12px;
  padding:12px 0;
  border-top:1px solid #eee;
}

.avaliacao-avatar{
  width:42px;
  height:42px;
  border-radius:50%;
  background:linear-gradient(135deg,var(--primary),var(--primary-2));
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  font-size:16px;
  flex-shrink:0;
}

.avaliacao-body{
  flex:1;
}

.avaliacao-top{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.avaliacao-nome{
  font-weight:800;
  font-size:13px;
}

.avaliacao-data{
  font-size:11px;
  color:var(--muted);
}

.avaliacao-stars{
  color:#facc15;
  font-size:14px;
  margin:2px 0;
}

.avaliacao-texto{
  font-size:13px;
  color:#444;
  line-height:1.4;
}

/* Desktop: avalia√ß√µes mais largas */
@media (min-width: 900px){
  .avaliacao-item{
    gap:16px;
  }
  .avaliacao-texto{
    font-size:14px;
  }
}
.card-info-extra{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:12px;
  color:#6b7280;
  margin:4px 0 6px;
}

.card-stars{
  color:#facc15;
  letter-spacing:-1px;
  font-size:13px;
}

.card-vendidos{
  font-weight:600;
}
/* ===== PRODUTOS RELACIONADOS ===== */
.relacionados-titulo{
  margin-top:18px;
  font-size:15px;
  font-weight:800;
}

.grid-relacionados{
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap:10px;
}

/* CARD RELACIONADO */
.grid-relacionados .card{
  border-radius:14px;
  box-shadow:0 6px 16px rgba(0,0,0,.08);
}

.grid-relacionados img{
  height:90px;
  object-fit:cover;
}

.grid-relacionados .card-body{
  padding:8px;
}

.grid-relacionados strong{
  font-size:12px;
  line-height:1.2;
}

/* MOBILE */
@media (max-width: 768px){
  .grid-relacionados{
    grid-template-columns: repeat(2, 1fr);
  }
}
/* ===== BIO PREMIUM ===== */
.bio-card{
  margin-top:16px;
  background:rgba(255,255,255,.18);
  border-radius:18px;
  padding:14px 16px;
  backdrop-filter: blur(8px);
  box-shadow:0 8px 24px rgba(0,0,0,.12);
}

.bio-header{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:12px;
  font-weight:800;
  letter-spacing:.04em;
  text-transform:uppercase;
  opacity:.85;
  margin-bottom:8px;
}

.bio-header i{
  font-size:16px;
}

.bio-text{
  font-size:14px;
  line-height:1.55;
  color:#fff;
  opacity:.95;

  display:-webkit-box;
  -webkit-line-clamp:3;
  -webkit-box-orient:vertical;
  overflow:hidden;
}

.bio-text.aberta{
  -webkit-line-clamp:unset;
  overflow:visible;
}

.bio-toggle{
  margin-top:10px;
  background:none;
  border:none;
  padding:0;
  font-size:12px;
  font-weight:800;
  color:#fff;
  cursor:pointer;
  opacity:.85;
}

.bio-toggle:hover{
  opacity:1;
  text-decoration:underline;
}


.banner-bio::before{
  content:"";
  position:absolute;
  top:-8px;
  left:0;
  right:0;
  height:1px;
  background:rgba(255,255,255,.25);
}


.banner h1{
  font-size:20px;
  font-weight:900;
  letter-spacing:-0.2px;
}

.bio-aberta{
  -webkit-line-clamp:unset;
  overflow:visible;
}


/* ===== STATUS LOJA (AVALIA√á√ïES + SELO) ===== */
.banner-status{
  position:absolute;
  top:14px;
  right:14px;
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap:6px;
}

/* Estrelas */
.banner-stars{
  background:rgba(255,255,255,.18);
  backdrop-filter:blur(6px);
  padding:6px 10px;
  border-radius:999px;
  font-size:13px;
  font-weight:800;
  color:#fff;
  display:flex;
  align-items:center;
  gap:4px;
}

.banner-stars span{
  color:#facc15;
  letter-spacing:-1px;
}

/* Loja verificada */
.banner-verificada{
  background:rgba(16,185,129,.18);
  color:#ecfdf5;
  font-size:11px;
  font-weight:900;
  padding:5px 10px;
  border-radius:999px;
  display:flex;
  align-items:center;
  gap:5px;
}

.banner-verificada i{
  color:#34d399;
  font-size:14px;
}

.endereco-click{
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:6px;
}

.endereco-click:hover{
  text-decoration:underline;
}


/* ===== POPUP MAPA PREMIUM ===== */
.mapa-card{
  background:#fff;
  width:100%;
  max-width:360px;
  border-radius:22px;
  padding:18px;
  box-shadow:0 25px 60px rgba(0,0,0,.25);
  animation:zoomIn .25s ease;
}

@keyframes zoomIn{
  from{transform:scale(.92);opacity:0}
  to{transform:scale(1);opacity:1}
}

.mapa-header{
  display:flex;
  align-items:center;
  gap:12px;
  margin-bottom:14px;
}

.mapa-icon{
  width:46px;
  height:46px;
  border-radius:14px;
  background:linear-gradient(135deg,var(--primary),var(--primary-2));
  color:#fff;
  font-size:22px;
  display:flex;
  align-items:center;
  justify-content:center;
}

.mapa-header strong{
  display:block;
  font-size:15px;
}

.mapa-header span{
  font-size:12px;
  color:#6b7280;
}

.mapa-endereco{
  font-size:14px;
  color:#374151;
  background:#f3f4f6;
  border-radius:14px;
  padding:12px;
  line-height:1.4;
}

.mapa-actions{
  display:flex;
  gap:10px;
  margin-top:16px;
}

.btn-mapa{
  flex:1;
  padding:12px;
  border:none;
  border-radius:999px;
  background:var(--primary);
  color:#fff;
  font-weight:900;
  cursor:pointer;
}

.btn-mapa-sec{
  flex:1;
  padding:12px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#fff;
  font-weight:700;
  cursor:pointer;
}

.loja-nome{
  color: var(--text);
}
.loja-info{
  color: var(--text);
  opacity: .9;
}

.item-nome{
  color: var(--text);
}

  



  






  
</style>
</head>

<body>

<div class="banner">
  <div class="banner-top">
    <div class="banner-logo">
      <img id="logo">
    </div>
    <div>
      
<div class="loja-titulo">
<h1 id="nomeLoja" class="loja-nome">Carregando‚Ä¶</h1>

  <!-- BOT√ÉO WHATSAPP -->
  <a id="btnWhatsLoja"
     target="_blank"
     style="display:none">
    <i class="ri-whatsapp-line"></i>
  </a>
</div>

<p id="cidadeLoja" class="loja-info"></p>

<p id="enderecoLoja" class="endereco-click loja-info">
  üìç <span id="enderecoTexto"></span>
</p>


    </div>
  </div>

<div class="bio-card" id="bioCard" style="display:none">
  <div class="bio-header">
    <i class="ri-information-line"></i>
    <span>Sobre a loja</span>
  </div>

  <div class="bio-text" id="bioLoja"></div>

  <button id="btnBio" class="bio-toggle" style="display:none">
    Ver mais
  </button>
</div>
<!-- STATUS DA LOJA (AVALIA√á√ïES + SELO) -->
<div class="banner-status">
  <div class="banner-stars" id="bannerStars">
  ‚è≥ Carregando avalia√ß√µes‚Ä¶
  </div>

  <div class="banner-verificada" id="bannerVerificada" style="display:none">
    <i class="ri-shield-check-fill"></i>
    Loja verificada
  </div>
</div>


</div>

<div class="search">
  <input id="busca" placeholder="Buscar produto ou servi√ßo">
</div>

<div class="tabs">
  <button id="tabServicos" onclick="setTab('SERVICO')">Servi√ßos</button>
  <button id="tabProdutos" onclick="setTab('PRODUTO')">Produtos</button>
</div>

<div id="grid" class="grid"></div>

<script>
const sb = supabase.createClient(
  "https://egxjgmzukjyyxmkukwub.supabase.co",
  "sb_publishable_EWwdrLOUk6KDHZGLuh4uRg_QDRtLeFi"
);

const lojaId = new URLSearchParams(location.search).get("l");
if(!lojaId){
  document.body.innerHTML = "<p style='text-align:center'>Loja n√£o identificada</p>";
  throw new Error("Sem loja");
}

let todos = [];
let tipoAtual = null;
let vendasPorProduto = {};   // { produto_id: total_vendido }
let avaliacoesPorItem = {}; // { produto_id: { total, soma } }

/* ================= LOAD ================= */
async function load(){

  /* CONFIG DE CORES */
const { data:config } = await sb
  .from("loja_config")
  .select("primary_color,secondary_color,text_color")
  .eq("user_id",lojaId)
  .maybeSingle();

if(config?.primary_color){
  document.documentElement.style.setProperty("--primary", config.primary_color);
}

if(config?.secondary_color){
  document.documentElement.style.setProperty("--primary-2", config.secondary_color);
}

if(config?.text_color){
  document.documentElement.style.setProperty("--text", config.text_color);
}


if(config?.primary_color && !localStorage.getItem("loja_tema_" + lojaId)){
  document.documentElement.style.setProperty("--primary",config.primary_color);
}

  if(config?.secondary_color){
    document.documentElement.style.setProperty("--primary-2",config.secondary_color);
  }

  /* LOJA */
 const { data:loja } = await sb
  .from("user_profile")
  .select("*, bio")
  .eq("user_id",lojaId)
  .maybeSingle();

if(!loja){
  document.body.innerHTML = "<p style='text-align:center'>Loja n√£o encontrada</p>";
  return;
}
const btnWhatsLoja = document.getElementById("btnWhatsLoja");


  nomeLoja.innerText = loja.negocio;
  cidadeLoja.innerText = `${loja.cidade} ‚Ä¢ ${loja.uf}`;

  
enderecoCompleto =
  `${loja.rua || ""}, ${loja.numero || ""} - ${loja.cidade || ""}/${loja.uf || ""}`;

document.getElementById("enderecoTexto").innerText = enderecoCompleto;
  // üî• BOT√ÉO WHATSAPP AO LADO DO NOME
if (loja.whatsapp) {

let numero = loja.whatsapp.replace(/\D/g, "");
if (numero.startsWith("55")) numero = numero.slice(2);

  const mensagem = encodeURIComponent(
    `Ol√°! Vim pelo app e gostaria de falar com a ${loja.negocio}.`
  );

  btnWhatsLoja.href = `https://wa.me/55${numero}?text=${mensagem}`;
  btnWhatsLoja.style.display = "inline-flex";
}

  if(loja.avatar_url) logo.src = loja.avatar_url;

const bioCard = document.getElementById("bioCard");
const bioBox = document.getElementById("bioLoja");
const btnBio = document.getElementById("btnBio");

if (loja.bio) {
  bioBox.innerText = loja.bio;
  bioCard.style.display = "block";

  setTimeout(() => {
    if (bioBox.scrollHeight > bioBox.clientHeight) {
      btnBio.style.display = "inline-block";
    }
  }, 50);

  btnBio.onclick = () => {
    const aberto = bioBox.classList.toggle("aberta");
    btnBio.innerText = aberto ? "Ver menos" : "Ver mais";
  };
}


  /* PRODUTOS */
  const { data } = await sb
    .from("produtos_servicos")
    .select("*")
    .eq("user_id",lojaId)
    .eq("ativo",true)
    .order("ordem_exibicao");

todos = data || [];

// üî• carrega dados auxiliares ANTES de renderizar
await carregarVendasProdutos();
await carregarAvaliacoesResumo();
await carregarMediaLoja();
await verificarLojaVerificada();

// üî• separa ativos
const servicosAtivos = todos.filter(
  i => i.tipo === "SERVICO" && i.ativo
);

const produtosAtivos = todos.filter(
  i => i.tipo === "PRODUTO" && i.ativo
);

// üî• controla abas
tabServicos.style.display = servicosAtivos.length ? "inline-block" : "none";
tabProdutos.style.display = produtosAtivos.length ? "inline-block" : "none";

// üî• define aba inicial
if (servicosAtivos.length) {
  tipoAtual = "SERVICO";
  setTab("SERVICO");
} else if (produtosAtivos.length) {
  tipoAtual = "PRODUTO";
  setTab("PRODUTO");
} else {
  tipoAtual = null;
  grid.innerHTML = `
    <p style="
      grid-column:1/-1;
      text-align:center;
      color:#6b7280;
      padding:40px 0;
      font-weight:600
    ">
      Nenhum servi√ßo ou produto dispon√≠vel no momento
    </p>
  `;
}


}

async function carregarVendasProdutos(){
  const { data, error } = await sb
    .from("pedidos_itens")
    .select(`
      produto_id,
      quantidade,
      pedidos!inner(status)
    `)
    .in("pedidos.status", ["PAGO","CONCLUIDO","FINALIZADO"]);

  if(error){
    console.error("Erro vendas:", error);
    return;
  }

  data.forEach(i=>{
    vendasPorProduto[i.produto_id] =
      (vendasPorProduto[i.produto_id] || 0) + i.quantidade;
  });
}
async function carregarAvaliacoesResumo(){
  const { data, error } = await sb
    .from("avaliacoes_loja")
    .select("produto_id, nota");

  if(error){
    console.error("Erro avalia√ß√µes resumo:", error);
    return;
  }

  data.forEach(a=>{
    if(!avaliacoesPorItem[a.produto_id]){
      avaliacoesPorItem[a.produto_id] = {
        total: 0,
        soma: 0
      };
    }
    avaliacoesPorItem[a.produto_id].total += 1;
    avaliacoesPorItem[a.produto_id].soma += a.nota;
  });
}



  

/* ================= RENDER ================= */
function render(){
  const q = busca.value.toLowerCase();
  grid.innerHTML = "";
const lista = todos
  .filter(i => i.tipo === tipoAtual && i.ativo)
  .filter(i => i.nome.toLowerCase().includes(q));


  if(!lista.length){
    grid.innerHTML = "<p style='grid-column:1/-1;text-align:center'>Nenhum item</p>";
    return;
  }

  grid.innerHTML = lista.map(i=>`
<div class="card" onclick="abrirProduto('${i.id}')">
      <div style="position:relative">
        ${i.promocao_ativa ? `<div class="badge">Promo√ß√£o</div>`:""}
        <img src="${i.imagem_url||""}">
      </div>
      <div class="card-body">
<strong class="item-nome">${i.nome}</strong>

  ${
    avaliacoesPorItem[i.id]
      ? `
        <div class="card-info-extra">
          <div class="card-stars">
            ${"‚òÖ".repeat(
              Math.round(avaliacoesPorItem[i.id].soma / avaliacoesPorItem[i.id].total)
            )}
            ${"‚òÜ".repeat(
              5 - Math.round(avaliacoesPorItem[i.id].soma / avaliacoesPorItem[i.id].total)
            )}
          </div>

          ${
            i.tipo === "PRODUTO"
              ? `<span class="card-vendidos">‚Ä¢ ${vendasPorProduto[i.id] || 0} vendidos</span>`
              : `<span>‚Ä¢ ${avaliacoesPorItem[i.id].total} avalia√ß√µes</span>`
          }
        </div>
      `
      : ""
  }

  <div class="meta">
    <span>
      ${
        i.tipo === "SERVICO"
          ? `‚è± ${i.duracao_minutos || 0} min`
          : i.controla_estoque
            ? `üì¶ Estoque: ${i.estoque_atual}`
            : `üì¶ Estoque livre`
      }
    </span>
    <span class="price">
      R$ ${Number(i.preco).toLocaleString("pt-BR",{minimumFractionDigits:2})}
    </span>
  </div>

  <button onclick="event.stopPropagation(); acao('${i.id}','${i.tipo}')">
    ${i.tipo==="SERVICO"
      ? (i.preco > 0 ? "Agendar" : "Or√ßamento")
      : "Comprar"}
  </button>

      </div>
    </div>
  `).join("");
}

function setTab(t){
  tipoAtual=t;
  tabServicos.classList.toggle("active",t==="SERVICO");
  tabProdutos.classList.toggle("active",t==="PRODUTO");
  render();
}

function acao(id,tipo){
  if(tipo==="SERVICO"){
    location.href = `agendar.html?l=${lojaId}&servico=${id}`;
  } else {
    produtoAtual = todos.find(p => p.id === id);
    adicionarAoCarrinho();
  }
}
busca.addEventListener("input", render);
load();

let produtoAtual = null;

function abrirProduto(id){
  produtoAtual = todos.find(p => p.id === id);
  if(!produtoAtual) return;

  mpImagem.src = produtoAtual.imagem_url || "";
  mpNome.innerText = produtoAtual.nome;
  mpDescricao.innerText = produtoAtual.descricao || "";
  mpPreco.innerText = Number(produtoAtual.preco || 0)
    .toLocaleString("pt-BR",{minimumFractionDigits:2});

  renderEstrelas();
  carregarAvaliacoes();
  carregarRelacionados();
  configurarBotaoAcaoModal(); // üëà NOVO

  modalProduto.style.display = "flex";
}

function configurarBotaoAcaoModal(){
  const btn = document.getElementById("btnAcaoModal");

  const obsBox = document.getElementById("obsCarrinhoBox");
  if (obsBox) {
    obsBox.style.display =
      produtoAtual.tipo === "PRODUTO" ? "block" : "none";
  }

  if(produtoAtual.tipo === "PRODUTO"){
    btn.innerText = "üõí Adicionar ao carrinho";
    btn.onclick = adicionarAoCarrinho;
    btn.style.display = "block";
    return;
  }

  if(produtoAtual.preco > 0){
    btn.innerText = "üìÖ Agendar";
    btn.onclick = () => {
      localStorage.setItem("SERVICO_SELECIONADO", produtoAtual.id);
      location.href = `agendar.html?l=${lojaId}&servico=${produtoAtual.id}`;
    };
    btn.style.display = "block";
    return;
  }

  btn.innerText = "üí¨ Solicitar or√ßamento";
  btn.onclick = solicitarOrcamentoWhats();
  btn.style.display = "block";
}

function solicitarOrcamentoWhats(){
  return () => {
    const cliente = JSON.parse(
      localStorage.getItem("CLIENTE_LOJA") || "{}"
    );

    const nomeCliente = cliente.nome || "Cliente";
    const whatsappCliente = cliente.whatsapp || "n√£o informado";

    const mensagem = encodeURIComponent(`
Ol√°! Gostaria de solicitar um or√ßamento.

üìå Servi√ßo: ${produtoAtual.nome}
üìù Descri√ß√£o: ${produtoAtual.descricao || "‚Äî"}

üë§ Cliente: ${nomeCliente}
üì± WhatsApp: ${whatsappCliente}
`);

    // whatsapp da loja (j√° carregado no banner)
    const lojaLink = document.getElementById("btnWhatsLoja")?.href;

    if(!lojaLink){
      alert("WhatsApp da loja n√£o dispon√≠vel");
      return;
    }

    window.open(lojaLink + `&text=${mensagem}`, "_blank");
  };
}


function fecharProduto(){
  if (window.mpComentario) mpComentario.value = "";
  if (window.mpObsCarrinho) mpObsCarrinho.value = "";
  notaSelecionada = 5;
  modalProduto.style.display = "none";
}


async function carregarAvaliacoes(){

  const { data, error } = await sb
    .from("avaliacoes_loja")
    .select("nota, comentario, cliente_nome, created_at")
    .eq("produto_id", produtoAtual.id)
    .eq("loja_id", lojaId)
    .order("created_at", { ascending: false });

  if(error){
    console.error("Erro avalia√ß√µes:", error);
    mpMedia.innerText = "Erro ao carregar avalia√ß√µes";
    return;
  }

  if(!data || data.length === 0){
    mpMedia.innerText = "Sem avalia√ß√µes ainda";
    mpComentarios.innerHTML = "";
    return;
  }

  /* M√âDIA */
  const media = (
    data.reduce((s,a)=>s + a.nota,0) / data.length
  ).toFixed(1);

  mpMedia.innerText = `‚≠ê ${media} ‚Ä¢ ${data.length} avalia√ß√µes`;

  /* LISTA */
  mpComentarios.innerHTML = data.map(a=>{
    const inicial = (a.cliente_nome || "C")
      .trim()
      .charAt(0)
      .toUpperCase();

    return `
      <div class="avaliacao-item">
        <div class="avaliacao-avatar">${inicial}</div>

        <div class="avaliacao-body">
          <div class="avaliacao-top">
            <div class="avaliacao-nome">
              ${a.cliente_nome || "Cliente"}
            </div>
            <div class="avaliacao-data">
              ${formatarDataBR(a.created_at)}
            </div>
          </div>

          <div class="avaliacao-stars">
            ${"‚òÖ".repeat(a.nota)}${"‚òÜ".repeat(5 - a.nota)}
          </div>

          <div class="avaliacao-texto">
            ${a.comentario}
          </div>
        </div>
      </div>
    `;
  }).join("");
}

function getCliente() {
  try {
    const raw = localStorage.getItem("CLIENTE_LOJA");
    if (!raw) return null;

    const c = JSON.parse(raw);

    if (!c?.nome) return null;

    return {
      nome: c.nome,
      whatsapp: c.whatsapp || null
    };
  } catch (e) {
    console.error("Erro ao ler CLIENTE_LOJA", e);
    return null;
  }
}

async function enviarAvaliacao() {
  if (!produtoAtual) {
    alert("Item n√£o identificado");
    return;
  }

  const cliente = getCliente();
  if (!cliente) {
    alert("Informe seu nome antes de avaliar");
    return;
  }

  if (!notaSelecionada) {
    alert("Selecione uma nota");
    return;
  }

  const comentario = mpComentario.value.trim();
  if (!comentario) {
    alert("Escreva um coment√°rio");
    return;
  }

  const payload = {
    loja_id: lojaId,
    produto_id: produtoAtual.id,
    nota: notaSelecionada,
    comentario,
    cliente_nome: cliente.nome,
    cliente_whatsapp: cliente.whatsapp
  };

  const { error } = await sb
    .from("avaliacoes_loja")
    .insert(payload);

  if (error) {
    console.error("Erro Supabase:", error);
    alert("Erro ao enviar avalia√ß√£o");
    return;
  }

  // reset UI
  mpComentario.value = "";
  notaSelecionada = 5;
  renderEstrelas();
  carregarAvaliacoes();

  alert("‚≠ê Avalia√ß√£o enviada com sucesso!");
}


function carregarRelacionados(){
  const relacionados = todos
    .filter(p =>
      p.categoria === produtoAtual.categoria &&
      p.id !== produtoAtual.id
    )
    .slice(0,4);

  mpRelacionados.innerHTML = relacionados.map(p=>`
    <div class="card" onclick="abrirProduto('${p.id}')">
      <img src="${p.imagem_url || ''}">
      <div class="card-body">
        <strong>${p.nome}</strong>
      </div>
    </div>
  `).join("");
}


let notaSelecionada = 5;

function renderEstrelas(){
  mpAvaliacao.innerHTML = [1,2,3,4,5].map(n=>`
    <i class="ri-star-${n <= notaSelecionada ? 'fill' : 'line'}"
       style="font-size:22px;color:#facc15;cursor:pointer"
       onclick="notaSelecionada=${n}; renderEstrelas()">
    </i>
  `).join("");
}

function getCarrinho(){
  return JSON.parse(
    localStorage.getItem("carrinho_" + lojaId) || "[]"
  );
}

function salvarCarrinho(carrinho){
  localStorage.setItem(
    "carrinho_" + lojaId,
    JSON.stringify(carrinho)
  );
}




function adicionarAoCarrinho(){
  if(produtoAtual.tipo !== "PRODUTO"){
    return;
  }

  const carrinho = getCarrinho();
  const comentario = mpObsCarrinho.value || "";

  const existente = carrinho.find(
    i => i.produto_id === produtoAtual.id
  );

  if(existente){
    existente.quantidade += 1;
    existente.comentario = comentario;
  }else{
    carrinho.push({
      produto_id: produtoAtual.id,
      nome: produtoAtual.nome,
      preco: produtoAtual.preco,
      imagem: produtoAtual.imagem_url,
      quantidade: 1,
      comentario
    });
  }

  salvarCarrinho(carrinho);
  alert("Produto adicionado ao carrinho üõí");
  fecharProduto();
}

function formatarDataBR(dataISO){
  const d = new Date(dataISO);
  return d.toLocaleDateString("pt-BR");
}

  
async function carregarMediaLoja(){
  if(!bannerStars) return;

  const { data, error } = await sb
    .from("avaliacoes_loja")
    .select("nota")
    .eq("loja_id", lojaId);

  if(error || !data || data.length === 0){
    bannerStars.innerHTML = "‚≠ê Sem avalia√ß√µes";
    return;
  }

  const soma = data.reduce((s,a)=>s + a.nota, 0);
  const media = (soma / data.length).toFixed(1);

  const estrelasCheias = Math.round(media);
  const estrelas =
    "‚òÖ".repeat(estrelasCheias) +
    "‚òÜ".repeat(5 - estrelasCheias);

  bannerStars.innerHTML = `
    <span>${estrelas}</span>
    ${media}
  `;
}

async function verificarLojaVerificada(){
  if(!bannerVerificada) return;

  const { data, error } = await sb
    .from("user_profile")
    .select("status")
    .eq("user_id", lojaId)
    .maybeSingle();

  if(!error && data?.status === "active"){
    bannerVerificada.style.display = "flex";
  }
}

let enderecoCompleto = "";

function abrirMapaPopup(){
  document.getElementById("mapaEndereco").innerText = enderecoCompleto;
  document.getElementById("mapaPopup").style.display = "flex";
}

function fecharMapaPopup(){
  document.getElementById("mapaPopup").style.display = "none";
}

function abrirNoMapa(){
  const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(enderecoCompleto)}`;
  window.open(url, "_blank");
}



  







  




  
</script>
<div class="modal" id="modalProduto" onclick="fecharProduto()">
  <div class="modal-box" onclick="event.stopPropagation()">

    <!-- IMAGEM -->
    <div class="modal-img">
      <img id="mpImagem">
    </div>

    <!-- CONTE√öDO -->
    <div class="modal-content">

<h2 id="mpNome" class="item-nome"></h2>

      <p id="mpDescricao"></p>

      <div class="modal-preco">
        R$ <span id="mpPreco"></span>
      </div>

      <!-- OBS PRODUTO -->
      <div id="obsCarrinhoBox">
        <label style="font-size:12px;font-weight:700;color:#555">
          Observa√ß√£o (opcional)
        </label>
        <textarea id="mpObsCarrinho"
          style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--border)">
        </textarea>
      </div>

      <!-- BOT√ÉO PRINCIPAL -->
      <div class="modal-actions">
        <button class="btn" id="btnAcaoModal"></button>
        <button class="btn-sec" onclick="fecharProduto()">Fechar</button>
      </div>

      <hr style="margin:16px 0;border:none;border-top:1px solid #eee">

      <!-- AVALIA√á√ÉO -->
      <div id="mpAvaliacao"></div>
      <p id="mpMedia" style="font-size:13px;color:#666"></p>

      <textarea id="mpComentario"
        placeholder="Escreva sua avalia√ß√£o"
        style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--border)">
      </textarea>

      <button class="btn" style="margin-top:10px" onclick="enviarAvaliacao()">
        ‚≠ê Enviar avalia√ß√£o
      </button>

      <div id="mpComentarios" style="margin-top:14px"></div>
<h3 class="relacionados-titulo">Produtos relacionados</h3>
<div id="mpRelacionados" class="grid-relacionados"></div>


    </div>
  </div>
</div>
<!-- POPUP MAPA PREMIUM -->
<div class="modal" id="mapaPopup" onclick="fecharMapaPopup()">
  <div class="mapa-card" onclick="event.stopPropagation()">

    <div class="mapa-header">
      <div class="mapa-icon">üìç</div>
      <div>
        <strong>Localiza√ß√£o da loja</strong>
        <span>Veja como chegar</span>
      </div>
    </div>

    <div class="mapa-endereco" id="mapaEndereco"></div>

    <div class="mapa-actions">
      <button class="btn-mapa" onclick="abrirNoMapa()">
        üó∫Ô∏è Abrir no mapa
      </button>

      <button class="btn-mapa-sec" onclick="fecharMapaPopup()">
        Fechar
      </button>
    </div>

  </div>
</div>

</body>
</html>
