<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-T97MS35TJ6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-T97MS35TJ6');
</script>
<title>P√°gina de agendamentos</title>

<meta name="viewport"
  content="width=device-width,
  initial-scale=1,
  maximum-scale=1,
  user-scalable=no,
  viewport-fit=cover">
<script>
(function(){
  const params = new URLSearchParams(location.search);
  const lojaId = params.get("l");
  if(!lojaId) return;

  const tema = localStorage.getItem("loja_tema_" + lojaId);
  if(!tema) return;

  try{
    const cfg = JSON.parse(tema);
    const root = document.documentElement;

    if(cfg.primary) root.style.setProperty("--primary", cfg.primary);
    if(cfg.secondary) root.style.setProperty("--primary-2", cfg.secondary);
    if(cfg.text) root.style.setProperty("--text", cfg.text);
  }catch(e){}
})();
</script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primary: var(--primary, #ff6a00);
  --primary-2: var(--primary-2, #ff9a57);
  --bg:#f4f6fb;
  --card:#fff;
  --border:#e5e7eb;
  --text: var(--text, #111827);
}



*{box-sizing:border-box;font-family:Inter}
html,body{margin:0;background:var(--bg)}

.header{
  height:56px;
  background:var(--primary);
  color:#fff;
  border-bottom:none;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:800;
  position:sticky;
  top:0;
}


.section{
  padding:18px 14px;
}

.title{
  font-weight:800;
  margin-bottom:10px;
}

.services{
  display:flex;
  gap:16px;
  overflow-x:auto;
}
.services::-webkit-scrollbar{display:none}

.service{
  min-width:220px;
  background:#fff;
  border-radius:22px;
  overflow:hidden;
  box-shadow:0 18px 44px rgba(0,0,0,.14);
  cursor:pointer;
}

.service img{
  width:100%;
  height:140px;
  object-fit:cover;
}

.service-info{
 padding:12px;
}

.service-name{font-weight:800;font-size:17px}
.service-price{color:var(--primary);font-weight:700;margin-top:6px}

.grid{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:14px;
}

.item{
  background:#fff;
  border:1px solid var(--border);
  border-radius:16px;
  padding:16px 0;
  text-align:center;
  font-weight:800;
  cursor:pointer;
}

.item:hover{
  background:#fff3ea;
}

.msg-final{
  background:#fff;
  border-radius:22px;
  padding:18px;
  box-shadow:0 18px 44px rgba(0,0,0,.18);
  font-weight:700;
}

.hidden {
  display: none;
}

.selected {
  border: 2px solid var(--primary) !important;
}

.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
.msg-final button{
  border:none;
  border-radius:12px;
  padding:12px;
  font-weight:700;
  cursor:pointer;
}

.msg-final button:first-child{
  background:#2563eb;
  color:#fff;
}

.msg-final button:last-child{
  background:#e5e7eb;
}
.days-scroll{
  display:flex;
  gap:14px;
  overflow-x:auto;
  padding-bottom:6px;
}
.days-scroll::-webkit-scrollbar{display:none}

.days-scroll .item{
  min-width:70px;
}


</style>
</head>

<body>

<div class="header">Agendar Servi√ßo</div>

<div class="section">
  <div class="title">Escolha um servi√ßo</div>
  <div class="services" id="services"></div>
</div>

<div class="section hidden" id="secDays">
  <div class="title">Escolha a data</div>
  <div class="days-scroll" id="days"></div>
</div>


<div class="section hidden" id="secTimes">
  <div class="title">Escolha o hor√°rio</div>
  <div class="grid" id="times"></div>
</div>


<div class="section" id="final"></div>

<script>
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
 "https://egxjgmzukjyyxmkukwub.supabase.co",
 "sb_publishable_EWwdrLOUk6KDHZGLuh4uRg_QDRtLeFi"
);
let usuarioLogado = null;
let clienteDB = null;

async function verificarLogin(){
  const { data } = await sb.auth.getUser();
  usuarioLogado = data?.user || null;
}
sb.auth.onAuthStateChange((_event, session) => {
  usuarioLogado = session?.user || null;
});

const lojaId = new URLSearchParams(location.search).get("l");
const servicoPreSelecionado =
  new URLSearchParams(location.search).get("servico");
const alterarId =
  new URLSearchParams(location.search).get("alterar");
const veioDoBotaoMais =
  new URLSearchParams(location.search).get("novo") === "1";

  

;

let duracao = 0;
let dados = {};
let DIAS_VALIDOS = [];

let cursorData = null;
let carregandoDias = false;
const BLOCO_DIAS = 7;


/* UTILS */
const toMin = h => { const [a,b]=h.split(":").map(Number); return a*60+b; }
const toHour = m => String(Math.floor(m/60)).padStart(2,"0")+":"+String(m%60).padStart(2,"0");
function hojeLocal(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}


async function carregarCliente(){
  if(!usuarioLogado) return;

  const { data } = await sb
    .from("clientes_profile")
    .select("nome, whatsapp, email")
    .eq("id", usuarioLogado.id)
    .maybeSingle();

  clienteDB = data || null;
}




  
/* ================= SERVI√áOS ================= */
async function carregarServicos(){
const { data } = await sb
  .from("produtos_servicos")
  .select(`
    id,
    nome,
    preco,
    imagem_url,
    duracao_minutos,
    ordem_exibicao,
    created_at,
    updated_at
  `)
  .eq("user_id", lojaId)
  .eq("ativo", true)
  // 1Ô∏è‚É£ quem tem ordem_exibicao vem primeiro
  .order("ordem_exibicao", { ascending: true, nullsLast: true })
  // 2Ô∏è‚É£ se empatar, o atualizado mais recente vem primeiro
  .order("updated_at", { ascending: false })
  // 3Ô∏è‚É£ para os sem ordem, respeita a ordem de cadastro
  .order("created_at", { ascending: true });


  const container = document.getElementById("services");

 container.innerHTML = data.map(s=>`
  <div class="service"
       data-id="${s.id}"
       onclick="selecionarServico(
         '${s.id}',
         ${s.duracao_minutos},
         '${s.nome}',
         ${Number(s.preco)}
       )">
       
    <img src="${s.imagem_url || 'https://via.placeholder.com/400'}">

    <div class="service-info">
      <div class="service-name">${s.nome}</div>
      <div class="service-price">R$ ${s.preco}</div>
    </div>
  </div>
`).join("");


  // ‚úÖ SE VEIO SERVI√áO PELA URL, J√Å SELECIONA AUTOMATICAMENTE
  if(servicoPreSelecionado){
    const s = data.find(x => x.id === servicoPreSelecionado);
    if(s){
selecionarServico(
  s.id,
  s.duracao_minutos,
  s.nome,
  Number(s.preco)
);
    }
  }
}



  
function formatarDia(dataISO){
  const [ano, mes, dia] = dataISO.split("-");
  return Number(dia);
}

function diaSemana(dataISO){
  const dias = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"];
  const [ano, mes, dia] = dataISO.split("-");
  const d = new Date(ano, mes - 1, dia);
  return dias[d.getDay()];
}
function addDias(data, qtd){
  const d = new Date(data);
  d.setDate(d.getDate() + qtd);
  return d.toISOString().split("T")[0];
}

async function carregarDiasLazy(){

  if(carregandoDias) return;
  carregandoDias = true;

  const inicio = cursorData || hojeLocal();
  const fim = addDias(inicio, BLOCO_DIAS);

  const { data: agenda } = await sb
    .from("agenda_loja")
    .select("*")
    .eq("user_id", lojaId)
    .eq("fechado", false)
    .gte("data", inicio)
    .lte("data", fim)
    .order("data");

  for(const d of agenda){

    let blocos;
    try{
      blocos = typeof d.horarios === "string"
        ? JSON.parse(d.horarios)
        : d.horarios;
    }catch{ continue }

    const { data: ags } = await sb
      .from("agendamentos")
      .select("hora_inicio,hora_fim")
      .eq("user_id", lojaId)
      .eq("data", d.data);

    const ocupados = ags.map(a => [
      toMin(a.hora_inicio),
      toMin(a.hora_fim)
    ]);

    let livre = false;

    blocos.forEach(b=>{
      let s = toMin(b.inicio);
      let e = toMin(b.fim);

      while(s + duracao <= e){
        if(!ocupados.some(o => !(s + duracao <= o[0] || s >= o[1]))){
          livre = true;
          break;
        }
        s += duracao;
      }
    });

    if(livre){
      DIAS_VALIDOS.push(d);
      renderizarDia(d, DIAS_VALIDOS.length - 1);
    }
  }

  cursorData = addDias(fim, 1);
  carregandoDias = false;
}
function renderizarDia(d, index){
  document.getElementById("days")
    .insertAdjacentHTML("beforeend", `
      <div class="item" onclick="selecionarDia(${index})">
        <div style="font-size:18px">${formatarDia(d.data)}</div>
        <div style="font-size:12px;color:#6b7280">
          ${diaSemana(d.data)}
        </div>
      </div>
    `);
}









  
async function selecionarServico(id, dur, nome, preco){

  document.querySelectorAll(".service")
    .forEach(el => el.classList.remove("selected"));

  const card = document.querySelector(`[data-id="${id}"]`);
  card?.classList.add("selected");

  card?.scrollIntoView({
    behavior: "smooth",
    inline: "center",
    block: "nearest"
  });

  dados.servico = id;
  dados.servico_nome = nome;
  dados.valor_servico = Number(preco) || 0; // ‚úÖ FIX FINAL
  duracao = dur;

  document.getElementById("secDays").classList.remove("hidden");
  document.getElementById("secTimes").classList.add("hidden");

  document.getElementById("times").innerHTML = "";
  document.getElementById("final").innerHTML = "";

  DIAS_VALIDOS = [];
  cursorData = null;
  carregandoDias = false;

  document.getElementById("days").innerHTML = "";

  carregarDiasLazy();
}





/* ================= DIA ‚Üí HOR√ÅRIOS ================= */
async function selecionarDia(index){

  /* ===== MARCA VISUAL DO DIA ===== */
  document.querySelectorAll("#days .item")
    .forEach(el => el.classList.remove("selected"));

  const itemSelecionado =
    document.querySelectorAll("#days .item")[index];

  if(itemSelecionado){
    itemSelecionado.classList.add("selected");
  }

  /* ===== MOSTRA SE√á√ÉO DE HOR√ÅRIOS ===== */
  document.getElementById("secTimes").classList.remove("hidden");

  /* ===== FEEDBACK DE CARREGAMENTO ===== */
  document.getElementById("times").innerHTML = `
    <div style="grid-column:1/-1;text-align:center;color:#6b7280;padding:14px">
      üîÑ Buscando hor√°rios dispon√≠veis...
    </div>
  `;

  /* ===== DADOS DO DIA ===== */
  const dia = DIAS_VALIDOS[index];
  dados.data = dia.data;

  /* ===== HOR√ÅRIOS DA AGENDA ===== */
  const blocos = typeof dia.horarios === "string"
    ? JSON.parse(dia.horarios)
    : dia.horarios;

  /* ===== AGENDAMENTOS J√Å OCUPADOS ===== */
  const { data: ag } = await sb
    .from("agendamentos")
    .select("hora_inicio,hora_fim")
    .eq("user_id", lojaId)
    .eq("data", dia.data);

  const ocupados = ag.map(a => [
    toMin(a.hora_inicio),
    toMin(a.hora_fim)
  ]);

  /* ===== GERA SLOTS LIVRES ===== */
  let slots = [];

  blocos.forEach(b => {
    let inicio = toMin(b.inicio);
    let fim = toMin(b.fim);

    while(inicio + duracao <= fim){
      const conflito = ocupados.some(o =>
        !(inicio + duracao <= o[0] || inicio >= o[1])
      );

      if(!conflito){
        slots.push(toHour(inicio));
      }

      inicio += duracao;
    }
  });

  /* ===== RENDERIZA HOR√ÅRIOS ===== */
  if(slots.length === 0){
    document.getElementById("times").innerHTML = `
      <div style="grid-column:1/-1;text-align:center;color:#6b7280;padding:14px">
        ‚ùå Nenhum hor√°rio dispon√≠vel neste dia
      </div>
    `;
    return;
  }

  document.getElementById("times").innerHTML = slots.map(h => `
    <div class="item" onclick="confirmar('${h}')">${h}</div>
  `).join("");
}



(async ()=>{
  await verificarLogin();
  await carregarCliente(); // üî• ESSENCIAL
  carregarServicos();

  // ‚ö†Ô∏è S√ì ABRE MODAL SE VEIO DO BOT√ÉO +
  if (veioDoBotaoMais && !clienteValido()) {
    abrirModal();
  }
})();


  
function fecharOverlay(){
  document.getElementById("overlayConfirm")?.remove();
}

function irParaAgendamentos(){
  // ajuste a rota se necess√°rio
  window.location.href = "agendamentosclientes.html?l=" + lojaId;
}
document.getElementById("days").addEventListener("scroll", e=>{
  const el = e.target;
  if(el.scrollLeft + el.clientWidth >= el.scrollWidth - 50){
    carregarDiasLazy();
  }
});

function getCliente(){

  // 1Ô∏è‚É£ Cliente logado ‚Üí SEMPRE do banco
  if(clienteDB?.whatsapp){
    return {
      nome: clienteDB.nome,
      whatsapp: clienteDB.whatsapp,
      email: clienteDB.email || usuarioLogado.email
    };
  }

  // 2Ô∏è‚É£ Cliente p√∫blico (sem login)
  try{
    const raw = localStorage.getItem("CLIENTE_LOJA");
    if(!raw) return null;

    const c = JSON.parse(raw);
    if(!c?.whatsapp) return null;

    return {
      nome: c.nome,
      whatsapp: c.whatsapp,
      email: c.email || null
    };
  }catch{
    return null;
  }
}

function clienteValido(){
  const c = getCliente();
  return !!(c?.nome && c?.whatsapp);
}


function abrirModal(){
  const modal = document.getElementById("clienteModal");
  if(!modal.classList.contains("hidden")) return;

  const cliente = getCliente();
  if(cliente){
    cliNome.value = cliente.nome || "";
    cliWhats.value = cliente.whatsapp || "";
    cliEmail.value = cliente.email || "";
  }

  modal.classList.remove("hidden");
}


function fecharModal(){
  if(!clienteValido()) return;
  document.getElementById("clienteModal").classList.add("hidden");
}

document.addEventListener("DOMContentLoaded", () => {
  const whatsInput = document.getElementById("cliWhats");
  if(!whatsInput) return;

  whatsInput.addEventListener("input", () => {
    let v = whatsInput.value.replace(/\D/g,"").slice(0,11);
    if(v.length > 6)
      v = `(${v.slice(0,2)}) ${v.slice(2,7)}-${v.slice(7)}`;
    else if(v.length > 2)
      v = `(${v.slice(0,2)}) ${v.slice(2)}`;
    whatsInput.value = v;
  });
});


async function salvarCliente(){

  const nome = cliNome.value.trim().toUpperCase();
  const whats = cliWhats.value.replace(/\D/g,"");
  const email = cliEmail.value.trim() || null;

  if(nome.length < 3 || whats.length < 10){
    alert("Informe nome completo e WhatsApp v√°lido");
    return;
  }

  // üî• SE VEIO DO BOT√ÉO +, N√ÉO SALVA NO PROFILE
  if (veioDoBotaoMais) {

    // salva s√≥ em mem√≥ria/localStorage
    const clienteTemp = { nome, whatsapp: whats, email };

    localStorage.setItem(
      "CLIENTE_LOJA",
      JSON.stringify(clienteTemp)
    );

    clienteDB = clienteTemp;
    fecharModal();
    return;
  }

  // üîê CLIENTE LOGADO ‚Üí SALVA NO PROFILE
  if (usuarioLogado) {
    await sb.from("clientes_profile").upsert({
      id: usuarioLogado.id,
      nome,
      whatsapp: whats,
      email
    });

    clienteDB = { nome, whatsapp: whats, email };
  }

  fecharModal();
}


async function confirmar(h){

const cliente = getCliente();

// ‚ö†Ô∏è S√≥ exige cliente se veio do bot√£o +
if (veioDoBotaoMais && !cliente) {
  abrirModal();
  return;
}


  const fim = toHour(toMin(h) + duracao);

  // üîÅ DEFINE ENDPOINT CORRETO
  const endpoint = alterarId
    ? "/api/update-agendamento"
    : "/api/create-agendamento";

  // üîÅ DEFINE PAYLOAD CORRETO
  const payload = alterarId
    ? {
        agendamento_id: alterarId,
        loja_id: lojaId,
        servico_id: dados.servico,
        servico_nome: dados.servico_nome,
        valor_servico: dados.valor_servico,
        data: dados.data,
        hora_inicio: h,
        hora_fim: fim,
        cliente_nome: cliente.nome,
        cliente_whatsapp: cliente.whatsapp,
        cliente_email: cliente.email || null,
        motivo: "ALTERACAO_CLIENTE"
      }
    : {
        loja_id: lojaId,
        servico_id: dados.servico,
        servico_nome: dados.servico_nome,
        valor_servico: dados.valor_servico,
        data: dados.data,
        hora_inicio: h,
        hora_fim: fim,
        cliente_nome: cliente.nome,
        cliente_whatsapp: cliente.whatsapp,
        cliente_email: cliente.email || null,
        cliente_id: usuarioLogado?.id || null
      };

  let response;

  try{
    response = await fetch(endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
  }catch(err){
    console.error("‚ùå ERRO DE REDE:", err);
    alert("‚ùå Falha de conex√£o com o servidor");
    return;
  }

if(!response.ok){
  const erro = await response.text();
  console.error("‚ùå ERRO API:", erro);
  alert("‚ùå Erro ao salvar agendamento");
  return;
}

// ‚úÖ SUCESSO

// üßπ limpa cliente tempor√°rio ap√≥s agendar
if (veioDoBotaoMais) {
  localStorage.removeItem("CLIENTE_LOJA");
}

document.body.insertAdjacentHTML("beforeend", `
  <div class="overlay" id="overlayConfirm">
    <div class="msg-final">
      ‚úÖ <strong>
        ${alterarId ? "Agendamento atualizado!" : "Agendamento confirmado!"}
      </strong><br><br>


        Servi√ßo: <b>${dados.servico_nome}</b><br>
        Data: <b>${dados.data}</b><br>
        Hor√°rio: <b>${h}</b><br><br>

        <div style="display:flex;gap:10px">
          <button onclick="irParaAgendamentos()" style="flex:1">
            üìã Meus Agendamentos
          </button>
          <button onclick="fecharOverlay()" style="flex:1">
            ‚úñ Fechar
          </button>
        </div>
      </div>
    </div>
  `);
}




</script>
<!-- MODAL CLIENTE -->
<div id="clienteModal" class="hidden">
  <div class="overlay" onclick="fecharModal()"></div>

  <div class="msg-final" style="max-width:380px">
    <h2 style="margin-bottom:6px">Seus dados</h2>
    <p style="color:#6b7280;margin-bottom:10px">
      Precisamos dessas informa√ß√µes para confirmar seu agendamento
    </p>

    <input id="cliNome" placeholder="NOME COMPLETO" style="text-transform:uppercase;width:100%;margin-bottom:10px">
    <input id="cliWhats" placeholder="WHATSAPP" inputmode="numeric" style="width:100%;margin-bottom:10px">
    <input id="cliEmail" placeholder="E-MAIL (opcional)" style="width:100%;margin-bottom:12px">

    <button onclick="salvarCliente()" style="width:100%">
      Salvar e continuar
    </button>
  </div>
</div>

</body>
</html>
