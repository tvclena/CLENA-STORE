<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Agenda F√°cil</title>

<meta name="viewport"
  content="width=device-width,
  initial-scale=1,
  maximum-scale=1,
  user-scalable=no,
  viewport-fit=cover">

  
<meta name="theme-color" content="#ff6a00">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Agenda F√°cil">

<link rel="apple-touch-icon" href="/icons/icon-192.png">
<link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512.png">


  
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primary:#ff6a00;
  --bg:#f4f6fb;
  --border:#e5e7eb;
  --text:#111827;
  --muted:#6b7280;
  --danger:#dc2626;

  /* ALTURAS BASE */
  --topbar-base:56px;
  --navbar-base:68px;

  /* SAFE AREAS (iOS / PWA) */
  --safe-top: env(safe-area-inset-top);
  --safe-bottom: env(safe-area-inset-bottom);

  /* ALTURAS FINAIS */
  --topbar-h: calc(var(--topbar-base) + var(--safe-top));
  --navbar-h: calc(var(--navbar-base) + var(--safe-bottom));
}

*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:Inter;
  -webkit-tap-highlight-color: transparent;
}

html,body{
  width:100vw;
  height:100vh;
  overflow:hidden;
  background:var(--bg);
}

/* ================= TOPBAR ================= */
.topbar{
  position:fixed;
  top:0;
  left:0;
  right:0;

  height:var(--topbar-h);

  padding:
    calc(8px + var(--safe-top))
    16px
    8px;

  background:#fff;
  border-bottom:1px solid var(--border);

  display:flex;
  align-items:center;
  justify-content:space-between;

  z-index:10;
}

.topbar h1{
  font-size:18px;
  font-weight:800;
}

.avatar{
  width:36px;
  height:36px;
  border-radius:50%;
  background:linear-gradient(135deg,#ff6a00,#ff9a57);
  display:flex;
  align-items:center;
  justify-content:center;
  color:#fff;
  font-weight:800;
  cursor:pointer;
  background-size:cover;
  background-position:center;
}

/* ================= CONTENT ================= */
.content{
  position:fixed;
  top:var(--topbar-h);
  bottom:var(--navbar-h);
  left:0;
  right:0;
  background:#fff;
  overflow:hidden;
}

iframe{
  width:100%;
  height:100%;
  border:none;
}

/* ================= NAVBAR ================= */
.navbar{
  position:fixed;
  bottom:0;
  left:0;
  right:0;

  height:var(--navbar-h);
  padding-bottom:var(--safe-bottom);

  background:#fff;
  border-top:1px solid var(--border);

  display:flex;
  justify-content:space-around;
  align-items:center;

  z-index:10;
}

.nav-item{
  font-size:11px;
  color:var(--muted);
  display:flex;
  flex-direction:column;
  align-items:center;
  cursor:pointer;
}

.nav-item i{
  font-size:22px;
}

.nav-item.active{
  color:var(--primary);
}

/* ================= OVERLAY ================= */
#overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

#overlay .box{
  background:#fff;
  padding:16px 18px;
  border-radius:14px;
  font-weight:800;
  color:#111;
  box-shadow:0 18px 50px rgba(0,0,0,.18);
}

/* ================= PROFILE MODAL ================= */
#profileModal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  display:none;
  align-items:flex-end;
  z-index:10000;
}

.profile-box{
  width:100%;
  background:#fff;
  border-radius:20px 20px 0 0;
  padding:18px;
  max-height:calc(92vh - var(--safe-top));
  overflow:auto;
}

.profile-top{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding-bottom:10px;
  border-bottom:1px solid var(--border);
}

.profile-top strong{
  font-size:15px;
}

.profile-top button{
  border:none;
  background:#f3f4f6;
  border-radius:12px;
  padding:10px 12px;
  font-weight:800;
  cursor:pointer;
}

.profile-img-wrap{
  display:flex;
  justify-content:center;
  margin:14px 0 10px;
}

.profile-img{
  width:86px;
  height:86px;
  border-radius:50%;
  background:#eee;
  background-size:cover;
  background-position:center;
  border:3px solid #fff;
  box-shadow:0 10px 26px rgba(0,0,0,.12);
  position:relative;
}

.profile-img .cam{
  position:absolute;
  right:-2px;
  bottom:-2px;
  width:34px;
  height:34px;
  border-radius:50%;
  background:linear-gradient(135deg,#ff6a00,#ff9a57);
  display:flex;
  align-items:center;
  justify-content:center;
  color:#fff;
  border:3px solid #fff;
}

/* ================= FORM ================= */
.profile-box h3{
  font-size:12px;
  margin:14px 0 8px;
  color:var(--muted);
  letter-spacing:.02em;
  text-transform:uppercase;
}

.field{
  display:flex;
  flex-direction:column;
  gap:6px;
  margin-bottom:10px;
}

.field label{
  font-size:12px;
  color:#6b7280;
}

.field input{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid var(--border);
  font-size:13px;
  outline:none;
}

.field input:focus{
  border-color:#ffd6b8;
  box-shadow:0 0 0 4px rgba(255,106,0,.10);
}

.row{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}

.btn-primary{
  width:100%;
  padding:14px;
  border:none;
  border-radius:999px;
  background:var(--primary);
  color:#fff;
  font-weight:900;
  margin-top:6px;
  cursor:pointer;
}

.btn-logout{
  width:100%;
  padding:14px;
  border:none;
  border-radius:999px;
  background:#fee2e2;
  color:var(--danger);
  font-weight:900;
  margin-top:10px;
  cursor:pointer;
}

.btn-primary.loading{
  opacity:.7;
  pointer-events:none;
}

.tip{
  font-size:12px;
  color:#6b7280;
  text-align:center;
  margin-top:10px;
}

</style>
</head>

<body>

<div id="overlay"><div class="box" id="overlayText">Validando sess√£o‚Ä¶</div></div>

<!-- TOPBAR -->
<div class="topbar">
  <h1>Agenda F√°cil</h1>
  <div class="avatar" id="avatar" onclick="openProfile()">A</div>
</div>

<!-- CONTENT -->
<div class="content">
  <iframe id="frame" src="home.html"></iframe>
</div>

<!-- NAVBAR -->
<nav class="navbar">
  <div class="nav-item active" onclick="go(this,'home.html')"><i class="ri-home-5-line"></i>Home</div>
  <div class="nav-item" onclick="go(this,'produtos.html')"><i class="ri-store-2-line"></i>Loja</div>
  <div class="nav-item" onclick="go(this,'agenda.html')"><i class="ri-calendar-line"></i>Agenda</div>
  <div class="nav-item" onclick="go(this,'config.html')"><i class="ri-settings-3-line"></i>Ajustes</div>
</nav>

<!-- PROFILE MODAL -->
<div id="profileModal" onclick="closeProfile(event)">
  <div class="profile-box" onclick="event.stopPropagation()">

    <div class="profile-top">
      <strong>Perfil</strong>
      <button onclick="closeProfile()">Fechar</button>
    </div>

    <div class="profile-img-wrap">
      <div class="profile-img" id="profileImg">
        <div class="cam" onclick="pFoto.click()"><i class="ri-camera-line"></i></div>
      </div>
    </div>

    <input type="file" id="pFoto" hidden accept="image/*">

    <h3>Dados do neg√≥cio</h3>

    <div class="field">
      <label>Nome da loja</label>
      <input id="pNegocio" placeholder="Ex: Barbearia Central">
    </div>

    <div class="field">
      <label>E-mail (login)</label>
      <input id="pEmail" disabled>
    </div>

    <div class="row">
      <div class="field">
        <label>WhatsApp</label>
        <input id="pWhatsapp" placeholder="(77) 99999-9999" inputmode="numeric">
      </div>
      <div class="field">
        <label>E-mail de contato</label>
        <input id="pEmailContato" placeholder="contato@seunegocio.com">
      </div>
    </div>

    <h3>Endere√ßo</h3>

    <div class="row">
      <div class="field">
        <label>CEP</label>
        <input id="pCep" placeholder="00000-000" inputmode="numeric">
      </div>
      <div class="field">
        <label>N√∫mero</label>
        <input id="pNumero" placeholder="123" inputmode="numeric">
      </div>
    </div>

    <div class="field">
      <label>Rua</label>
      <input id="pRua" placeholder="Rua Exemplo">
    </div>

    <div class="row">
      <div class="field">
        <label>Bairro</label>
        <input id="pBairro" placeholder="Centro">
      </div>
      <div class="field">
        <label>Cidade</label>
        <input id="pCidade" placeholder="Barreiras">
      </div>
    </div>

    <div class="field">
      <label>UF</label>
      <input id="pUf" placeholder="BA" maxlength="2" style="text-transform:uppercase">
    </div>

<button class="btn-primary" id="btnSalvar" onclick="salvarPerfil()">
  Salvar altera√ß√µes
</button>
    <button class="btn-logout" onclick="sair()">Sair da conta</button>

    <div class="tip">Nada √© obrigat√≥rio ‚Äî mas preencher ajuda na organiza√ß√£o ‚úÖ</div>
  </div>
</div>

<script>
const sb = supabase.createClient(
  "https://egxjgmzukjyyxmkukwub.supabase.co",
  "sb_publishable_EWwdrLOUk6KDHZGLuh4uRg_QDRtLeFi"
);

let user = null;
let profile = null;
let fotoBlob = null; // ‚úÖ vamos enviar blob reduzido

/* ================= AUTH ================= */
/* ================= AUTH ================= */
async function proteger(){
  try{
    const { data:{ session } } = await sb.auth.getSession();

    if(!session){
      location.href = "login.html";
      return;
    }

    user = session.user;

  }catch(err){
    console.error("Erro na sess√£o:", err);
  }finally{
    // üîê GARANTE que o overlay SOME SEMPRE
    overlay.style.display = "none";

    // carrega perfil sem travar UI
    carregarPerfil().catch(e=>console.warn(e));
  }
}


proteger();
if (Notification.permission !== "granted") {
  setTimeout(() => {
    pedirNotificacao();
  }, 1000);
}


  
async function carregarPerfil(){
  const { data:p, error } = await sb
    .from("user_profile")
    .select("*")
    .eq("user_id", user.id)
    .single();

  if(error || !p){
    console.warn("Perfil n√£o encontrado");
    return;
  }

  profile = p;

  const letra = (p.negocio?.[0] || user.email?.[0] || "A").toUpperCase();
  avatar.textContent = letra;

  pEmail.value = user.email || "";
  pNegocio.value = p.negocio || "";
  pWhatsapp.value = maskWhats(p.whatsapp || "");
  pEmailContato.value = p.email_contato || "";

  pCep.value = p.cep || "";
  pRua.value = p.rua || "";
  pNumero.value = p.numero || "";
  pBairro.value = p.bairro || "";
  pCidade.value = p.cidade || "";
  pUf.value = (p.uf || "").toUpperCase();

  if (p.avatar_url) {
    profileImg.style.backgroundImage = `url(${p.avatar_url})`;
    avatar.style.backgroundImage = `url(${p.avatar_url})`;
    avatar.textContent = "";
  }
} // ‚úÖ FECHAMENTO CORRETO DA FUN√á√ÉO




/* ================= NAV ================= */
function go(el,page){
  document.querySelectorAll(".nav-item").forEach(i=>i.classList.remove("active"));
  el.classList.add("active");
  frame.src = page;
}

/* ================= PROFILE MODAL ================= */
function openProfile(){ profileModal.style.display="flex"; }
function closeProfile(e){
  if(e && e.target && e.target.id !== "profileModal") return;
  profileModal.style.display="none";
}

/* ================= MASKS ================= */
function maskWhats(digits){
  const v = String(digits).replace(/\D/g,'').slice(0,11);
  if(!v) return "";
  return v.replace(/^(\d{2})(\d)/,"($1) $2").replace(/(\d{5})(\d)/,"$1-$2");
}
pWhatsapp.addEventListener("input", e=>{
  e.target.value = maskWhats(e.target.value);
});
pCep.addEventListener("input", e=>{
  let v = e.target.value.replace(/\D/g,'').slice(0,8);
  if(v.length>5) v = v.slice(0,5)+"-"+v.slice(5);
  e.target.value = v;
});

/* ================= CEP AUTOCOMPLETE ================= */
pCep.addEventListener("blur", async ()=>{
  const cep = pCep.value.replace(/\D/g,'');
  if(cep.length !== 8) return;
  try{
    const r = await fetch(`https://viacep.com.br/ws/${cep}/json/`).then(r=>r.json());
    if(r.erro) return;
    if(!pRua.value) pRua.value = r.logradouro || "";
    if(!pBairro.value) pBairro.value = r.bairro || "";
    if(!pCidade.value) pCidade.value = r.localidade || "";
    if(!pUf.value) pUf.value = (r.uf || "").toUpperCase();
  }catch(err){}
});

/* ================= FOTO: PREVIEW IMEDIATO + REDU√á√ÉO ================= */
pFoto.addEventListener("change", ()=>{
  const file = pFoto.files?.[0];
  if(!file) return;

  // preview imediato
  const tempUrl = URL.createObjectURL(file);
  profileImg.style.backgroundImage = `url(${tempUrl})`;
  avatar.style.backgroundImage = `url(${tempUrl})`;
  avatar.textContent = "";

  // gera blob quadrado e leve (para mobile)
  const img = new Image();
  img.onload = ()=>{
    const size = Math.min(img.width, img.height);
    const canvas = document.createElement("canvas");
    canvas.width = canvas.height = 700;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(
      img,
      (img.width - size)/2,
      (img.height - size)/2,
      size, size,
      0,0,700,700
    );
    canvas.toBlob((b)=>{ fotoBlob = b; }, "image/jpeg", 0.9);
  };
  img.src = tempUrl;
});


/* ================= SAVE PROFILE ================= */
async function salvarPerfil(){
  const btn = document.getElementById("btnSalvar");

  overlayText.innerText = "Salvando altera√ß√µes‚Ä¶";
  overlay.style.display = "flex";
  btn.classList.add("loading");
  btn.innerText = "Salvando...";

  try{
let avatarPath = profile?.avatar_url || null;

if (pFoto.files.length) {
  const file = pFoto.files[0];
  const path = `perfil/${user.id}.jpg`; // ‚úÖ AGORA DEFINIDO

  const { error: uploadError } = await sb.storage
    .from("avatars")
    .upload(path, file, { upsert: true });

  if (uploadError) throw uploadError;

  const { data } = sb.storage
    .from("avatars")
    .getPublicUrl(path);

  avatarPath = data.publicUrl;
}


    const { error } = await sb
      .from("user_profile")
      .update({
        negocio: pNegocio.value || null,
        whatsapp: pWhatsapp.value || null,
        email_contato: pEmailContato.value || null,
        avatar_url: avatarPath,
        cep: pCep.value || null,
        rua: pRua.value || null,
        numero: pNumero.value || null,
        bairro: pBairro.value || null,
        cidade: pCidade.value || null,
        uf: pUf.value || null
      })
      .eq("user_id", user.id);

    if(error) throw error;

    profileModal.style.display = "none";

  }catch(err){
    alert(err.message || "Erro ao salvar perfil");
  }finally{
    overlay.style.display = "none";
    btn.classList.remove("loading");
    btn.innerText = "Salvar altera√ß√µes";
  }
}



 
/* ================= LOGOUT ================= */
async function sair(){
  overlayText.innerText = "Saindo‚Ä¶";
  overlay.style.display = "flex";
  await sb.auth.signOut();
  location.href="login.html";
}



async function pedirNotificacao() {
  if (!("Notification" in window)) return;

  const perm = await Notification.requestPermission();
  if (perm !== "granted") return;

  const reg = await navigator.serviceWorker.ready;
  const sub = await reg.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: "BFhPEOPNlTlGO4rcw-ZcZAPNByDk1uZA2KJIAm4K4wLwp0TTTtQjtDZi-5YGt7LzwhGun-DU_dXpKwQcHWPruVw"
  });

  // salva subscription no Supabase
  await sb.from("push_subscriptions").insert({
    user_id: user.id,
    subscription: sub
  });
}


  
</script>
  <script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/sw.js");
}
</script>

</body>
</html>
