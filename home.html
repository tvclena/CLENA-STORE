<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Home • Agenda Fácil</title>

<meta name="viewport"
  content="width=device-width,
  initial-scale=1,
  maximum-scale=1,
  user-scalable=no,
  viewport-fit=cover">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primary:#ff6a00;
  --bg:#f6f7fb;
  --card:#ffffff;
  --muted:#6b7280;
  --border:#e5e7eb;
  --radius:18px;
}

*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:Inter;
  -webkit-tap-highlight-color: transparent;
}

html, body{
  width:100%;
  height:100%;
  overflow-x:hidden;
  overscroll-behavior:none;
}

body{
  background:var(--bg);
  overflow-y:auto;
  scrollbar-width:none;
}
body::-webkit-scrollbar{display:none}

.app{
  padding:16px;
}

/* ================= HEADER ================= */
.header{
  margin-bottom:18px;
}
.header h1{
  font-size:22px;
  font-weight:800;
}
.header span{color:var(--primary)}
.header p{
  font-size:13px;
  color:var(--muted);
  margin-top:4px;
}

/* ================= KPIs ================= */
.grid{
  display:grid;
  grid-template-columns:repeat(2,minmax(0,1fr));
  gap:14px;
  margin-bottom:22px;
}

.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:16px;
  box-shadow:0 8px 22px rgba(0,0,0,.07);
  position:relative;
}

.card small{
  font-size:12px;
  color:var(--muted);
  font-weight:600;
}

.card h2{
  font-size:22px;
  margin-top:6px;
  font-weight:800;
}

.card i{
  position:absolute;
  bottom:14px;
  right:14px;
  font-size:24px;
  color:var(--primary);
  opacity:.9;
}

/* ================= LISTAS ================= */
.list{
  background:var(--card);
  border-radius:var(--radius);
  padding:16px;
  box-shadow:0 8px 22px rgba(0,0,0,.07);
  margin-bottom:18px;
}

.list h3{
  font-size:15px;
  font-weight:800;
  margin-bottom:14px;
}

/* ================= AGENDA ================= */
.agenda-card{
  display:grid;
  grid-template-columns:56px 1fr auto;
  gap:12px;
  padding:12px;
  border-radius:14px;
  background:#f9fafb;
  margin-bottom:10px;
  align-items:center;
}

.agenda-card img{
  width:56px;
  height:56px;
  border-radius:12px;
  object-fit:cover;
  background:#eee;
}

.agenda-info{
  display:flex;
  flex-direction:column;
  gap:4px;
}

.agenda-info strong{
  font-size:13px;
}

.agenda-info small{
  font-size:12px;
  color:var(--muted);
}

.agenda-actions{
  display:flex;
  flex-direction:column;
  gap:6px;
}

.whats-btn{
  font-size:11px;
  padding:6px 10px;
  border-radius:999px;
  background:#dcfce7;
  color:#166534;
  text-align:center;
  font-weight:700;
}

/* ================= STATUS SELECT ================= */
.status-select{
  font-size:11px;
  font-weight:700;
  border-radius:999px;
  padding:6px 8px;
  border:1px solid var(--border);
}
.status-select.confirmado{background:#ecfeff;color:#0891b2}
.status-select.concluido{background:#ecfdf5;color:#16a34a}
.status-select.cancelado{background:#fef2f2;color:#dc2626}

/* ================= AVISOS ================= */
.aviso{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px;
  background:#f9fafb;
  border-radius:14px;
  margin-bottom:10px;
  font-size:13px;
}

.badge{
  background:#fff7ed;
  color:var(--primary);
  padding:4px 10px;
  border-radius:999px;
  font-size:11px;
  font-weight:700;
}

/* ================= EMPTY ================= */
.empty{
  text-align:center;
  padding:16px;
  font-size:13px;
  color:var(--muted);
}
</style>
</head>

<body>

<div class="app">

  <div class="header">
    <h1>Bem-vindo ao <span>Agenda Fácil</span></h1>
    <p>Resumo geral da sua loja</p>
  </div>

  <!-- KPIs -->
  <div class="grid">

    <div class="card">
      <small>Agendamentos hoje</small>
      <h2 id="kpiHoje">0</h2>
      <i class="ri-calendar-check-line"></i>
    </div>

    <div class="card">
      <small>Clientes</small>
      <h2 id="kpiClientes">0</h2>
      <i class="ri-user-3-line"></i>
    </div>

    <div class="card">
      <small>Serviços ativos</small>
      <h2 id="kpiServicos">0</h2>
      <i class="ri-scissors-line"></i>
    </div>

    <div class="card">
      <small>Produtos ativos</small>
      <h2 id="kpiProdutos">0</h2>
      <i class="ri-store-2-line"></i>
    </div>

    <div class="card">
      <small>Faturamento do mês</small>
      <h2 id="kpiFaturamento">R$ 0</h2>
      <i class="ri-currency-line"></i>
    </div>

  </div>

  <!-- AGENDA -->
  <div class="list">
    <h3 id="tituloAgenda">Agenda</h3>
    <div id="agendaHoje">
      <div class="empty">Nenhum horário agendado</div>
    </div>
  </div>

  <!-- AVISOS -->
  <div class="list">
    <h3>Avisos</h3>
    <div id="avisosBox"></div>
  </div>

</div>

<script>
const sb = supabase.createClient(
  "https://egxjgmzukjyyxmkukwub.supabase.co",
  "sb_publishable_EWwdrLOUk6KDHZGLuh4uRg_QDRtLeFi"
);

let dataAtual = new Date();

function dataISO(d){
  return d.toLocaleDateString("en-CA");
}

async function carregarHome(){
  const {data:{session}} = await sb.auth.getSession();
  if(!session) return;

  const lojaId = session.user.id;

  const hoje = dataISO(new Date());
  const inicioMes = new Date();
  inicioMes.setDate(1);

  /* KPIs */
  const { count: qtdHoje } = await sb
    .from("agendamentos")
    .select("*",{count:"exact",head:true})
    .eq("user_id",lojaId)
    .eq("data",hoje)
    .neq("status","CANCELADO");

  kpiHoje.innerText = qtdHoje || 0;

  const { count: qtdClientes } = await sb
    .from("clientes_loja")
    .select("*",{count:"exact",head:true})
    .eq("loja_id",lojaId);

  kpiClientes.innerText = qtdClientes || 0;

  const { count: qtdServicos } = await sb
    .from("produtos_servicos")
    .select("*",{count:"exact",head:true})
    .eq("user_id",lojaId)
    .eq("tipo","SERVICO")
    .eq("ativo",true);

  kpiServicos.innerText = qtdServicos || 0;

  const { count: qtdProdutos } = await sb
    .from("produtos_servicos")
    .select("*",{count:"exact",head:true})
    .eq("user_id",lojaId)
    .eq("tipo","PRODUTO")
    .eq("ativo",true);

  kpiProdutos.innerText = qtdProdutos || 0;

  const { data: faturamento } = await sb
    .from("agendamentos")
    .select("valor_servico")
    .eq("user_id",lojaId)
    .gte("data",dataISO(inicioMes))
    .in("status",["CONFIRMADO","CONCLUIDO"]);

  const total = faturamento?.reduce((s,v)=>s+Number(v.valor_servico||0),0)||0;
  kpiFaturamento.innerText =
    total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});

  carregarAgendaDia(lojaId);
  gerarAvisos({qtdServicos,qtdProdutos});
}

async function carregarAgendaDia(lojaId){
  const data = dataISO(dataAtual);
  tituloAgenda.innerText =
    dataAtual.toDateString()===new Date().toDateString()
    ? "Agenda • Hoje"
    : "Agenda • "+dataAtual.toLocaleDateString("pt-BR");

  const { data: agenda } = await sb
    .from("agendamentos")
    .select(`
      id,hora_inicio,cliente_nome,cliente_whatsapp,status,servico_id,valor_servico
    `)
    .eq("user_id",lojaId)
    .eq("data",data)
    .neq("status","CANCELADO")
    .order("hora_inicio");

  agendaHoje.innerHTML = "";

  if(!agenda || !agenda.length){
    agendaHoje.innerHTML = `<div class="empty">Nenhum horário</div>`;
    return;
  }

  const servicoIds = [...new Set(agenda.map(a=>a.servico_id).filter(Boolean))];
  let servicosMap={};

  if(servicoIds.length){
    const { data: servicos } = await sb
      .from("produtos_servicos")
      .select("id,nome,preco,imagem_url")
      .in("id",servicoIds);

    servicos?.forEach(s=>servicosMap[s.id]=s);
  }

  agenda.forEach(a=>{
    const s = servicosMap[a.servico_id]||{};
    const hora = a.hora_inicio?.slice(0,5);
    const valor = Number(s.preco||a.valor_servico||0)
      .toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
    const whatsapp = a.cliente_whatsapp
      ? `https://wa.me/55${a.cliente_whatsapp.replace(/\D/g,"")}`:"#";

    agendaHoje.innerHTML += `
      <div class="agenda-card">
        <img src="${s.imagem_url||'https://via.placeholder.com/56'}">
        <div class="agenda-info">
          <strong>${hora} • ${s.nome||'Serviço'}</strong>
          <small>${valor} • ${a.cliente_nome}</small>
        </div>
        <div class="agenda-actions">
          <a class="whats-btn" href="${whatsapp}" target="_blank">Whats</a>
          <select class="status-select ${a.status.toLowerCase()}"
            onchange="alterarStatus('${a.id}',this.value)">
            <option value="CONFIRMADO" ${a.status==="CONFIRMADO"?"selected":""}>CONFIRMADO</option>
            <option value="CONCLUIDO" ${a.status==="CONCLUIDO"?"selected":""}>CONCLUÍDO</option>
            <option value="CANCELADO">CANCELADO</option>
          </select>
        </div>
      </div>`;
  });
}

function gerarAvisos({qtdServicos,qtdProdutos}){
  avisosBox.innerHTML="";
  if(!qtdServicos){
    avisosBox.innerHTML+=`
      <div class="aviso">
        <span>Cadastre seus serviços</span>
        <span class="badge">Importante</span>
      </div>`;
  }
  if(!qtdProdutos){
    avisosBox.innerHTML+=`
      <div class="aviso">
        <span>Cadastre seus produtos</span>
        <span class="badge">Opcional</span>
      </div>`;
  }
}

async function alterarStatus(id,status){
  const {data:{session}} = await sb.auth.getSession();
  if(!session) return;

  await sb.from("agendamentos")
    .update({status})
    .eq("id",id)
    .eq("user_id",session.user.id);

  carregarAgendaDia(session.user.id);
}

/* SWIPE DIAS */
let startX=0;
document.addEventListener("touchstart",e=>startX=e.touches[0].clientX);
document.addEventListener("touchend",e=>{
  const diff=e.changedTouches[0].clientX-startX;
  if(Math.abs(diff)<60) return;
  dataAtual.setDate(dataAtual.getDate()+(diff<0?1:-1));
  sb.auth.getSession().then(({data:{session}})=>{
    if(session) carregarAgendaDia(session.user.id);
  });
});

carregarHome();
</script>

</body>
</html>
