<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Agenda • Agenda Fácil</title>

<meta name="viewport"
  content="width=device-width,
  initial-scale=1,
  maximum-scale=1,
  user-scalable=no,
  viewport-fit=cover">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primary:#ff6a00;
  --bg:#f4f6f9;
  --card:#ffffff;
  --border:#e5e7eb;
  --radius:16px;
  --danger:#dc2626;
  --soft:#fff7ed;
}

*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:Inter;
}

html,body{
  width:100%;
  height:100%;
  overflow:hidden;
  background:var(--bg);
}

/* ================= HEADER ================= */
.header{
  height:52px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 16px;
  background:#fff;
  border-bottom:1px solid var(--border);
}
.header h1{
  font-size:16px;
  font-weight:700;
}
.header button{
  border:none;
  background:var(--soft);
  border-radius:10px;
  padding:6px 12px;
  font-weight:600;
  cursor:pointer;
}

/* ================= WEEK ================= */
.week{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:8px;
  padding:12px;
}

.day{
  background:#fff;
  border-radius:14px;
  padding:8px;
  border:1px solid var(--border);
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  cursor:pointer;
}

.day small{
  font-size:11px;
  color:#6b7280;
  text-align:center;
}
.day strong{
  font-size:14px;
  text-align:center;
}

.badge{
  font-size:10px;
  padding:3px 6px;
  border-radius:999px;
  text-align:center;
  margin-top:6px;
}
.badge.closed{
  background:#fee2e2;
  color:var(--danger);
}

.time{
  font-size:11px;
  background:#f9fafb;
  border-radius:8px;
  padding:4px;
  text-align:center;
  margin-top:4px;
}

/* ================= MODAL ================= */
#modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:flex-end;
  z-index:1000;
}
.modal-box{
  background:#fff;
  width:100%;
  border-radius:18px 18px 0 0;
  padding:18px;
}
.modal-box h3{
  margin-bottom:12px;
}
.horario{
  display:flex;
  gap:8px;
  margin-bottom:8px;
}
.horario input{
  flex:1;
  padding:10px;
  border-radius:10px;
  border:1px solid var(--border);
}
.horario button{
  background:#fee2e2;
  border:none;
  border-radius:10px;
  padding:0 12px;
}
.add-btn{
  background:#eaf1ff;
  border:none;
  border-radius:12px;
  padding:10px;
  width:100%;
}
.save-btn{
  background:var(--primary);
  color:#fff;
  border:none;
  border-radius:30px;
  padding:14px;
  width:100%;
  margin-top:12px;
}
</style>
</head>

<body>

<div class="header">
  <button onclick="changeWeek(-7)">◀</button>
  <h1 id="weekLabel"></h1>
  <button onclick="changeWeek(7)">▶</button>
</div>

<div class="week" id="week"></div>

<!-- MODAL -->
<div id="modal">
  <div class="modal-box">
    <h3 id="modalDate"></h3>
    <label><input type="checkbox" id="fechado"> Dia fechado</label>
    <div id="horarios"></div>
    <button class="add-btn" onclick="addHorario()">+ Adicionar horário</button>
    <button class="save-btn" onclick="salvar()">Salvar</button>
  </div>
</div>

<script>
const sb = supabase.createClient(
  "https://egxjgmzukjyyxmkukwub.supabase.co",
  "sb_publishable_EWwdrLOUk6KDHZGLuh4uRg_QDRtLeFi"
);

let userId, agenda={}, start=new Date(), selected="";

(async()=>{
  const {data:{session}}=await sb.auth.getSession();
  if(!session) return location.href="login.html";
  userId=session.user.id;
  carregar();
})();

function changeWeek(v){
  start.setDate(start.getDate()+v);
  carregar();
}

async function carregar(){
  const {data}=await sb.from("agenda_loja").select("*");
  agenda={};
  data?.forEach(r=>agenda[r.data]={fechado:r.fechado,horarios:r.horarios||[]});
  render();
}

function render(){
  const week=document.getElementById("week");
  week.innerHTML="";

  const d=new Date(start);
  d.setDate(d.getDate()-d.getDay());

  document.getElementById("weekLabel").innerText =
    d.toLocaleDateString("pt-BR",{day:"2-digit",month:"short"})+" - "+
    new Date(d.getTime()+6*86400000).toLocaleDateString("pt-BR",{day:"2-digit",month:"short"});

  for(let i=0;i<7;i++){
    const date=new Date(d);
    date.setDate(d.getDate()+i);
    const key=date.toISOString().slice(0,10);

    const div=document.createElement("div");
    div.className="day";
    div.onclick=()=>open(key);

    div.innerHTML=`<small>${date.toLocaleDateString("pt-BR",{weekday:"short"})}</small>
                   <strong>${date.getDate()}</strong>`;

    if(agenda[key]){
      if(agenda[key].fechado){
        div.innerHTML+=`<div class="badge closed">Fechado</div>`;
      }else{
        agenda[key].horarios.forEach(h=>{
          div.innerHTML+=`<div class="time">${h.inicio}-${h.fim}</div>`;
        });
      }
    }

    week.appendChild(div);
  }
}

function open(key){
  selected=key;
  modal.style.display="flex";
  modalDate.innerText=new Date(key).toLocaleDateString("pt-BR",{weekday:"long",day:"numeric",month:"long"});
  fechado.checked=agenda[key]?.fechado||false;
  horarios.innerHTML="";
  (agenda[key]?.horarios||[{inicio:"",fim:""}]).forEach(h=>addHorario(h.inicio,h.fim));
}

function addHorario(i="",f=""){
  const div=document.createElement("div");
  div.className="horario";
  div.innerHTML=`<input type="time" value="${i}">
                 <input type="time" value="${f}">
                 <button onclick="this.parentElement.remove()">✕</button>`;
  horarios.appendChild(div);
}

async function salvar(){
  const fechadoVal=fechado.checked;
  const horariosVal=[];
  document.querySelectorAll(".horario").forEach(h=>{
    const i=h.children[0].value,f=h.children[1].value;
    if(i&&f) horariosVal.push({inicio:i,fim:f});
  });

  await sb.from("agenda_loja").upsert({
    user_id:userId,
    data:selected,
    fechado:fechadoVal,
    horarios:horariosVal
  },{onConflict:"user_id,data"});

  modal.style.display="none";
  carregar();
}
</script>

</body>
</html>
