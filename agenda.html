<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Agenda • AgendaBeauty</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  
<script src="env.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* === (CSS MANTIDO, SEM ALTERAÇÃO) === */
:root{
  --primary:#ff6a00;
  --bg:#f4f6f9;
  --card:#ffffff;
  --border:#e5e7eb;
  --radius:18px;
  --danger:#dc2626;
  --holiday:#2563eb;
  --soft:#fff7ed;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:Inter}
body{background:var(--bg);padding:32px}
/* ... restante do CSS inalterado ... */
</style>
</head>

<body>

<!-- (HTML VISUAL INALTERADO) -->

<script>
/* ================= SUPABASE (VIA ENV) ================= */
if (!window.supabaseClient) {
  window.supabaseClient = supabase.createClient(
    window.ENV.SUPABASE_URL,
    window.ENV.SUPABASE_ANON_KEY
  );
}
const sb = window.supabaseClient;

/* ================= CONTEXTO ================= */
/* depois vem do login / session */
const LOJA_ID = localStorage.getItem("loja_id")
  || "00000000-0000-0000-0000-000000000001";

/* ================= AGENDA ================= */
let agenda={},currentDate=new Date(),selectedDate="",selectedWeekDay=0;

/* ================= SALVAR ================= */
async function salvarAgenda(){
  let slots=[];
  if(!fechadoEl.checked){
    document.querySelectorAll(".horario").forEach(h=>{
      const i=h.children[0].value,f=h.children[1].value;
      if(i&&f) slots.push({inicio:i,fim:f});
    });

    slots.sort((a,b)=>a.inicio.localeCompare(b.inicio));
    for(let x=1;x<slots.length;x++){
      if(slots[x].inicio<=slots[x-1].fim){
        alert("Horários não podem encostar.");
        return;
      }
    }
  }

  const base={loja_id:LOJA_ID,fechado:fechadoEl.checked,horarios:slots};
  const registros=[];

  if(replicarEl.checked){
    const y=currentDate.getFullYear(),m=currentDate.getMonth();
    for(let d=1;d<=31;d++){
      const dt=new Date(y,m,d);
      if(dt.getMonth()===m && dt.getDay()===selectedWeekDay){
        registros.push({...base,data:dt.toISOString().slice(0,10)});
      }
    }
  } else {
    registros.push({...base,data:selectedDate});
  }

  await sb
    .from("agenda_loja")
    .upsert(registros,{onConflict:"loja_id,data"});

  modal.style.display="none";
  carregarAgenda();
}

/* ================= LOAD ================= */
async function carregarAgenda(){
  const {data} = await sb
    .from("agenda_loja")
    .select("*")
    .eq("loja_id",LOJA_ID);

  agenda={};
  data?.forEach(r=>{
    agenda[r.data]={fechado:r.fechado,horarios:r.horarios||[]};
  });

  renderCalendar();
}

carregarAgenda();
</script>

</body>
</html>
