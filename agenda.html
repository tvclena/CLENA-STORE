<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-T97MS35TJ6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-T97MS35TJ6');
</script>
<title>Agenda â€¢ Agenda FÃ¡cil</title>

<meta name="viewport"
  content="width=device-width,
  initial-scale=1,
  maximum-scale=1,
  user-scalable=no,
  viewport-fit=cover">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primary:#ff6a00;
  --bg:#f4f6f9;
  --card:#fff;
  --border:#e5e7eb;
  --muted:#6b7280;
  --danger:#dc2626;
}

*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:Inter;
  -webkit-tap-highlight-color:transparent;
}

html,body{
  width:100%;
  height:100%;
  overflow:hidden;
  background:var(--bg);
}

/* ===== HEADER ===== */
.header{
  height:52px;
  background:#fff;
  border-bottom:1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 12px;
}
.header h1{
  font-size:14px;
  font-weight:700;
}
.header button{
  background:#fff7ed;
  border:none;
  border-radius:10px;
  padding:6px 10px;
  font-weight:700;
}

/* ===== CALENDAR ===== */
.calendar{
  padding:10px;
  overflow-y:auto;
  height:calc(100vh - 52px);
}

.weekdays{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  font-size:10px;
  color:var(--muted);
  text-align:center;
  margin-bottom:6px;
}

.days{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:6px;
}

.day{
  background:#fff;
  border:1px solid var(--border);
  border-radius:12px;
  padding:6px 4px;
  min-height:78px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
}

.day.inactive{
  opacity:.35;
}

.day strong{
  font-size:13px;
}

.badge{
  font-size:9px;
  padding:2px 6px;
  border-radius:999px;
  margin-top:4px;
}
.badge.closed{
  background:#fee2e2;
  color:var(--danger);
}

.time{
  font-size:9px;
  background:#f9fafb;
  border-radius:6px;
  padding:2px 4px;
  margin-top:3px;
  width:100%;
  text-align:center;
}

/* ===== MODAL ===== */
#modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:flex-end;
  z-index:1000;
}

.sheet{
  background:#fff;
  width:100%;
  height:88vh;
  border-radius:18px 18px 0 0;
  display:flex;
  flex-direction:column;
}

.sheet-header{
  padding:14px;
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  font-weight:800;
}

.sheet-body{
  flex:1;
  padding:14px;
  overflow-y:auto;
}

.sheet-body label{
  font-size:12px;
  display:block;
  margin-bottom:6px;
}

.horario{
  display:flex;
  gap:6px;
  margin-bottom:6px;
}
.horario input{
  flex:1;
  padding:8px;
  border-radius:10px;
  border:1px solid var(--border);
}
.horario button{
  background:#fee2e2;
  border:none;
  border-radius:10px;
  padding:0 10px;
}

.add-btn{
  width:100%;
  padding:10px;
  background:#eef2ff;
  border:none;
  border-radius:12px;
  margin-top:8px;
}

.replica{
  margin-top:12px;
  font-size:12px;
}

.sheet-footer{
  padding:12px;
  border-top:1px solid var(--border);
  display:flex;
  gap:10px;
}

.sheet-footer button{
  flex:1;
  height:44px;
  border:none;
  border-radius:999px;
  font-weight:800;
}

.btn-save{
  background:var(--primary);
  color:#fff;
}
.btn-close{
  background:#e5e7eb;
}
</style>
</head>

<body>

<div class="header">
  <button onclick="changeMonth(-1)">â—€</button>

  <h1 id="monthLabel"></h1>

 <select id="seletorColaborador"
  style="
    border:1px solid #e5e7eb;
    border-radius:10px;
    padding:6px 10px;
    font-weight:700;
    font-size:12px;
  ">
</select>


  <button onclick="changeMonth(1)">â–¶</button>
</div>


<div class="calendar">
  <div class="weekdays">
    <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div>
    <div>Qui</div><div>Sex</div><div>SÃ¡b</div>
  </div>
  <div class="days" id="days"></div>
</div>

<!-- MODAL -->
<div id="modal">
  <div class="sheet">
    <div class="sheet-header">
      <span id="modalDate"></span>
      <span onclick="fecharModal()">âœ•</span>
    </div>

    <div class="sheet-body">
      <label><input type="checkbox" id="fechado"> Dia fechado</label>

      <div id="horarios"></div>

      <button class="add-btn" onclick="addHorario()">+ Adicionar horÃ¡rio</button>

      <div class="replica">
        <label><input type="checkbox" id="replicaSemana"> Replicar para todas as <span id="replicaDia"></span></label>
      </div>
    </div>

    <div class="sheet-footer">
      <button class="btn-close" onclick="fecharModal()">Fechar</button>
      <button class="btn-save" onclick="salvar()">Salvar</button>
    </div>
  </div>
</div>

<script>
const sb = supabase.createClient(
  "https://egxjgmzukjyyxmkukwub.supabase.co",
  "sb_publishable_EWwdrLOUk6KDHZGLuh4uRg_QDRtLeFi"
);
let lojaId;
let colaboradorSelecionado = "LOJA";

let userId, agenda = {}, current = new Date(), selected = "", dirty = false;

(async () => {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) location.href = "login.html";

  lojaId = session.user.id;

  await carregarColaboradores();

  // ðŸ”¥ herda do home se existir
 if (
  window.parent &&
  window.parent.profissionalSelecionado &&
  window.parent.profissionalSelecionado !== "LOJA" &&
  /^[0-9a-f-]{36}$/i.test(window.parent.profissionalSelecionado)
) {
  colaboradorSelecionado = window.parent.profissionalSelecionado;
  document.getElementById("seletorColaborador").value = colaboradorSelecionado;
}


  definirUserId();
  carregar();
})();
async function carregarColaboradores(){
  const select = document.getElementById("seletorColaborador");

  // limpa tudo e recria corretamente
  select.innerHTML = `<option value="LOJA">Agenda da Loja</option>`;

  const { data } = await sb
    .from("colaboradores")
    .select("id, nome")
    .eq("loja_id", lojaId)
    .eq("ativo", true)
    .order("nome");

  (data || []).forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = c.nome;
    select.appendChild(opt);
  });

  select.onchange = () => {
    colaboradorSelecionado = select.value;
    definirUserId();
    carregar();
  };
}

function definirUserId(){
  if (
    colaboradorSelecionado &&
    colaboradorSelecionado !== "LOJA" &&
    /^[0-9a-f-]{36}$/i.test(colaboradorSelecionado)
  ) {
    userId = colaboradorSelecionado; // agenda do colaborador
  } else {
    userId = lojaId; // agenda da loja
  }
}




function changeMonth(v){
  current.setMonth(current.getMonth()+v);
  carregar();
}

async function carregar(){
  const { data, error } = await sb
    .from("agenda_loja")
    .select("data, fechado, horarios")
    .eq("user_id", userId); // ðŸ”¥ FILTRO CORRETO

  agenda = {};

  data?.forEach(r => {
    let horarios = [];

    // garante parse correto
    if (typeof r.horarios === "string") {
      try {
        horarios = JSON.parse(r.horarios);
      } catch {
        horarios = [];
      }
    } else if (Array.isArray(r.horarios)) {
      horarios = r.horarios;
    }

    agenda[r.data] = {
      fechado: r.fechado,
      horarios
    };
  });

  render();
}


function render(){
  days.innerHTML="";
  const y=current.getFullYear(), m=current.getMonth();
  monthLabel.innerText=current.toLocaleDateString("pt-BR",{month:"long",year:"numeric"});

  const first=new Date(y,m,1).getDay();
  const total=new Date(y,m+1,0).getDate();

  for(let i=0;i<first;i++) days.innerHTML+=`<div class="day inactive"></div>`;

  for(let d=1;d<=total;d++){
    const key=`${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const div=document.createElement("div");
    div.className="day";
    div.onclick=()=>open(key);

    div.innerHTML=`<strong>${d}</strong>`;

    if(agenda[key]){
      if(agenda[key].fechado){
        div.innerHTML+=`<div class="badge closed">Fechado</div>`;
      }else{
        agenda[key].horarios.slice(0,2).forEach(h=>{
          div.innerHTML+=`<div class="time">${h.inicio}-${h.fim}</div>`;
        });
      }
    }
    days.appendChild(div);
  }
}

function open(key){
  selected=key;
  dirty=false;
  modal.style.display="flex";

const date = dateFromISO(key);
  
  modalDate.innerText=date.toLocaleDateString("pt-BR",{weekday:"long",day:"numeric",month:"long"});
  replicaDia.innerText=date.toLocaleDateString("pt-BR",{weekday:"long"});

  fechado.checked = agenda[key]?.fechado || false;
  horarios.innerHTML = "";

  const lista =
    Array.isArray(agenda[key]?.horarios) && agenda[key].horarios.length
      ? agenda[key].horarios
      : [];

  lista.forEach(h => addHorario(h.inicio, h.fim));
} // âœ… FECHAMENTO CORRETO


function fecharModal(){
  if(dirty && confirm("Deseja salvar as alteraÃ§Ãµes?")){
    salvar();
  }else{
    modal.style.display="none";
  }
}

function addHorario(i="",f=""){
  dirty=true;
  const div=document.createElement("div");
  div.className="horario";
  div.innerHTML=`
    <input type="time" value="${i}">
    <input type="time" value="${f}">
    <button onclick="this.parentElement.remove()">âœ•</button>
  `;
  horarios.appendChild(div);
}

async function salvar(){
  const fechadoVal = fechado.checked;
  const horariosVal = [];

  document.querySelectorAll(".horario").forEach(h=>{
    const i=h.children[0].value;
    const f=h.children[1].value;
    if(i && f) horariosVal.push({inicio:i,fim:f});
  });

  const base = { fechado: fechadoVal, horarios: horariosVal };

  const updates = new Set();
  
  updates.add(selected);

 if(replicaSemana.checked){
  const baseDate = dateFromISO(selected);
  const wd = baseDate.getDay();
  const y = baseDate.getFullYear();
  const m = baseDate.getMonth();

  const lastDay = new Date(y, m + 1, 0).getDate();

  for(let d=1; d<=lastDay; d++){
    const date = new Date(y, m, d, 12, 0, 0);
    if(date.getDay() === wd){
      const key = `${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
      updates.add(key);
    }
  }
}


  for(const d of updates){
    await sb.from("agenda_loja").upsert({
      user_id: userId,
      data: d,
      ...base
    }, { onConflict: "user_id,data" });
  }

  replicaSemana.checked = false;
  modal.style.display = "none";
  carregar();
}
function dateFromISO(iso) {
  const [y, m, d] = iso.split("-").map(Number);
  return new Date(y, m - 1, d, 12, 0, 0); // meio-dia local
}

</script>

</body>
</html>
