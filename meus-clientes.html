<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Meus Clientes</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primary:#ff6a00;
  --gold:#d4af37;
  --bg:#f6f7fb;
  --card:#ffffff;
  --muted:#6b7280;
  --border:#e5e7eb;
  --radius:18px;
}
*{box-sizing:border-box;font-family:Inter}
body{margin:0;background:var(--bg);height:100vh;overflow:hidden}

/* HEADER */
.header{
  height:56px;background:#fff;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;padding:0 16px
}
.header strong{font-size:16px;font-weight:800}
.header button{
  border:none;background:#f3f4f6;border-radius:10px;
  padding:8px 14px;font-weight:700;cursor:pointer
}

/* SEARCH */
.search{padding:14px;background:#fff;border-bottom:1px solid var(--border)}
.search input{
  width:100%;padding:12px 14px;border-radius:14px;
  border:1px solid var(--border);font-size:14px
}

/* LIST */
.list{padding:14px;height:calc(100vh - 56px - 70px);overflow:auto}

/* RANKING */
.ranking{
  background:#fff;border-radius:18px;padding:14px;
  margin-bottom:14px;box-shadow:0 10px 28px rgba(0,0,0,.08)
}
.ranking h3{font-size:14px;margin-bottom:8px}
.rank-item{
  display:flex;justify-content:space-between;
  font-size:13px;font-weight:700;margin-bottom:6px
}

/* CARD */
.card{
  background:#fff;border-radius:18px;padding:14px;
  box-shadow:0 10px 28px rgba(0,0,0,.08);
  margin-bottom:12px;display:flex;gap:12px;cursor:pointer
}
.avatar{
  width:48px;height:48px;border-radius:50%;
  background:linear-gradient(135deg,#ff6a00,#ff9a57);
  display:flex;align-items:center;justify-content:center;
  color:#fff;font-weight:900;font-size:18px
}
.info{flex:1}
.info strong{font-size:14px}
.info small{font-size:12px;color:var(--muted)}
.meta{text-align:right;font-size:12px;font-weight:700}
.meta span{display:block;font-size:11px;color:var(--muted)}

/* WHATS */
.whats-link{text-decoration:none;margin-left:6px}
.whats{
  font-size:22px;
  color:var(--gold);
  transition:.2s;
}
.whats-link:hover .whats{
  color:#25D366;
  transform:scale(1.15);
}

/* MODAL */
.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.5);
  display:flex;align-items:center;justify-content:center;z-index:999
}
.modal{
  background:#fff;border-radius:18px;
  width:92%;max-width:420px;
  max-height:85vh;overflow:auto;padding:16px
}
.modal h3{margin-bottom:12px}
.hist-item{
  display:flex;gap:10px;margin-bottom:10px;
  border-bottom:1px solid var(--border);padding-bottom:10px
}
.hist-img{
  width:42px;height:42px;border-radius:10px;
  background:#e5e7eb;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;
  font-weight:800;color:#999
}
.hist-img img{
  width:100%;height:100%;
  object-fit:cover;border-radius:10px
}
.hist-info{flex:1;font-size:13px}
.hist-info b{display:block}
.close{
  margin-top:12px;width:100%;padding:10px;
  border:none;border-radius:10px;font-weight:800
}
</style>
</head>

<body>

<div class="header">
  <strong>Meus clientes</strong>
  <button onclick="window.parent.fecharClientes()">Fechar</button>
</div>

<div class="search">
  <input id="busca" placeholder="Buscar cliente" oninput="filtrarClientes()">
</div>

<div class="list" id="lista"></div>

<script>
const sb = supabase.createClient(
  "https://egxjgmzukjyyxmkukwub.supabase.co",
  "sb_publishable_EWwdrLOUk6KDHZGLuh4uRg_QDRtLeFi"
);
let NOME_LOJA = "Minha loja";
function saudacao(){
  const hora = new Date().getHours();
  if (hora >= 5 && hora < 12) return "Bom dia";
  if (hora >= 12 && hora < 18) return "Boa tarde";
  return "Boa noite";
}

function msgWhats(nome){
  const texto =
    `${saudacao()} ${nome}! Tudo bem?\n\n` +
    `Aqui √© *${NOME_LOJA}*.`;

  return encodeURIComponent(texto);
}

let clientes=[], clientesFiltrados=[], historico={};
function formatarDataBR(data){
  if(!data) return "";
  const [y, m, d] = data.split("-");
  return `${d}/${m}/${y}`;
}

  


async function carregarClientes(){
  const { data:{ session } } = await sb.auth.getSession();
  const lojaId = session.user.id;
// üîπ BUSCA NOME DA LOJA
const { data: perfil, error: erroPerfil } = await sb
  .from("user_profile")
  .select("negocio")
  .eq("user_id", lojaId)
  .single();

if (!erroPerfil && perfil?.negocio) {
  NOME_LOJA = perfil.negocio;
}



  const { data: ags } = await sb
    .from("agendamentos")
    .select("cliente_id, cliente_nome, cliente_whatsapp, data, hora_inicio, servicos, valor_total")
    .eq("loja_id", lojaId)
    .neq("status","CANCELADO");

  const mapa={};

  ags.forEach(a=>{
    if(!mapa[a.cliente_id]){
      mapa[a.cliente_id]={
        id:a.cliente_id,
        nome:a.cliente_nome,
        whatsapp:a.cliente_whatsapp,
        total:0,
        valor:0,
        ultima:null
      };
      historico[a.cliente_id]=[];
    }

    const qtd = Array.isArray(a.servicos) ? a.servicos.length : 1;
    mapa[a.cliente_id].total += qtd;
    mapa[a.cliente_id].valor += Number(a.valor_total||0);

    if(!mapa[a.cliente_id].ultima || a.data > mapa[a.cliente_id].ultima){
      mapa[a.cliente_id].ultima = a.data;
    }

    (a.servicos||[]).forEach(s=>{
      historico[a.cliente_id].push({
        nome:s.nome,
        preco:s.preco,
        foto: s.foto || s.imagem || s.imagem_url || null,
        data:a.data,
        hora:a.hora_inicio
      });
    });
  });

  clientes = Object.values(mapa);
  clientesFiltrados = clientes;
  render();
}

function render(){
  lista.innerHTML="";

  const ranking=[...clientes].sort((a,b)=>b.valor-a.valor).slice(0,3);
  lista.innerHTML+=`
    <div class="ranking">
      <h3>üèÜ Clientes mais lucrativos</h3>
      ${ranking.map((c,i)=>`
        <div class="rank-item">
          ${i+1}¬∫ ${c.nome}
          <span>R$ ${c.valor.toFixed(2)}</span>
        </div>
      `).join("")}
    </div>
  `;

  clientesFiltrados.forEach(c=>{
    lista.innerHTML+=`
      <div class="card" onclick="abrir('${c.id}')">
        <div class="avatar">${c.nome[0]}</div>

        <div class="info">
          <strong>${c.nome}</strong>
          <small>${c.whatsapp||""}</small>
        </div>

        <div class="meta">
          ${c.total} servi√ßos
          <span>Ticket: R$ ${(c.valor/c.total).toFixed(2)}</span>
        </div>

        ${c.whatsapp ? `
          <a class="whats-link"
            onclick="event.stopPropagation()"
            href="https://wa.me/55${c.whatsapp.replace(/\D/g,'')}?text=${msgWhats(c.nome)}"
            target="_blank">
            <i class="ri-whatsapp-line whats"></i>
          </a>
        ` : ``}
      </div>
    `;
  });
}

function abrir(id){
  document.body.insertAdjacentHTML("beforeend",`
    <div class="overlay" onclick="this.remove()">
      <div class="modal" onclick="event.stopPropagation()">
        <h3>Hist√≥rico</h3>
        ${historico[id].map(h=>`
          <div class="hist-item">
            <div class="hist-img">
              ${h.foto ? `<img src="${h.foto}" onerror="this.remove()">` : 'IMG'}
            </div>
<div class="hist-info">
  <b>${h.nome}</b>
  ${formatarDataBR(h.data)} ${h.hora}<br>
  R$ ${Number(h.preco).toFixed(2)}
</div>

          </div>
        `).join("")}
        <button class="close" onclick="this.closest('.overlay').remove()">Fechar</button>
      </div>
    </div>
  `);
}

function filtrarClientes(){
  const q = busca.value.toLowerCase();
  clientesFiltrados = clientes.filter(c =>
    c.nome.toLowerCase().includes(q)
  );
  render();
}

carregarClientes();
</script>

</body>
</html>
